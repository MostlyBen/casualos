{"version":2,"updates":[{"id":0,"timestamp":1719881100284,"update":"AcUBjomFiAQAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwCOiYWIBAAGc3lzdGVtAgQAjomFiAQBEWFiLnNoZWxsLnJlZ3VsYXRlJwCOiYWIBAAEZm9ybQIEAI6JhYgEEwdub3RoaW5nJwCOiYWIBAAMb25BbnlCb3REcmFnAgQAjomFiAQbuwFALy9jb250cm9scyBncmlkIHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJHcmlkU25hcFN0YXRlKQp7CiAgICBvcy5hZGREcm9wU25hcCgiZ3JpZCIpOwp9CgovL2NvbnRyb2xzIGJvdCBzbmFwCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQm90U25hcFN0YXRlKQp7CiAgICBvcy5hZGREcm9wU25hcCgiZmFjZSIpOwp9JwCOiYWIBAAIcmVtZW1iZXICBACOiYWIBNcBKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAI6JhYgEAAhhYklnbm9yZQIEAI6JhYgE/gEEdHJ1ZSgAjomFiAQADGFiQm90VmVyc2lvbgF9hAMnAI6JhYgEAAdhYlNoZWxsAgQAjomFiASEAgR0cnVlJwEEYm90cyQzNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMBJwCOiYWIBIkCBnN5c3RlbQIEAI6JhYgEigIPYWIuc2hlbGwuY3JlYXRlJwCOiYWIBIkCBGZvcm0CBACOiYWIBJoCB25vdGhpbmcnAI6JhYgEiQILZGVzY3JpcHRpb24CBACOiYWIBKICPUJvdCB1c2VkIHRvIGNyZWF0ZS9tYW5pZmVzdCBib3RzIGludG8gYW4gYWN0dWFsIHNjZW5lL3BvcnRhbC4nAI6JhYgEiQIMYWJDcmVhdGVCb3RzAgQAjomFiATgAsIgQC8vREVWIE5PVEU6IE5FRUQgVE8gVU5ERVJTVEFORCBXSEFUIFRPIERPIElGIEFOIEFSUkFZIElTIEdJVkVOCgovL2NoZWNrcyBmb3IgaW5pdGlhbCBib290IGJvb2xlYW4KbGV0IGluaXRpYWxCb290ID0gdGhhdC5pbml0aWFsQm9vdDsKLy9ib3RzIHRvIGJlIGdlbmVyYXRlZApsZXQgYm90RGF0YSA9IHRoYXQuYm90czsKLy93aGVyZSBkaWQgdGhlIGRhdGEgY29tZSBmcm9tIChvcHRpb25hbCkKbGV0IG9yaWdpbiA9IHRoYXQub3JpZ2luOwovL3doYXQgc3R1ZGlvIGlzIHRoaXMgZGF0YSBmcm9tIChvcHRpb25hbCkKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8KLy92ZXJzaW9uIG9mIHRoZSBkYXRhIChvcHRpb25hbCkKbGV0IHZlcnNpb24gPSB0aGF0LnZlcnNpb247Ci8vaWRNYXAgYW5kIG5ld0JvdHMgYXJlIHVzZWQgdG8gbWFuYWdlIHRoZSBpbmNvbWluZyBib3QgZGF0YQpsZXQgaWRNYXAgPSBuZXcgTWFwKCk7CmxldCBuZXdCb3RzID0gW107CgovL3RoaXMgbG9vcCBjcmVhdGVzIHRoZSBuZXcgYm90cyBhbmQgdGhlbiBwYWNrYWdlcyB0aGVtIGZvciBhZGRpdGlvbmFsIHByb2Nlc3NpbmcsIHdoaWxlIGFkZGluZyBhbnkgbmVlZGVkIGFkZGl0aW9uYWwgdGFncwpmb3IgKGNvbnN0IHByb3BlcnR5IGluIGJvdERhdGEpCnsKICAgIGNvbnN0IG5ld0JvdCA9IGJvdERhdGFbcHJvcGVydHldOwogICAgY29uc3QgYm90VG90YWwgPSBPYmplY3Qua2V5cyhib3REYXRhKS5sZW5ndGg7CiAgICBjb25zdCBhYklET3JpZ2luID0ge2FiSURPcmlnaW46IG9yaWdpbiwgYWJJRFN0dWRpbzogdGhhdC5zdHVkaW99OwogICAgY29uc3QgYWJHcmlkRm9jdXMgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKICAgIGlmIChuZXdCb3QudGFncykgCiAgICB7CiAgICAgICAgaWYgKG5ld0JvdC50YWdzLmNyZWF0b3IpIAogICAgICAgIHsKICAgICAgICAgICAgYWJJRE9yaWdpbi5vbGRDcmVhdG9yID0gbmV3Qm90LnRhZ3MuY3JlYXRvcjsKICAgICAgICB9CgogICAgICAgIGxldCB0YXJnZXRQb3NpdGlvbjsKCiAgICAgICAgdHJ5IAogICAgICAgIHsKICAgICAgICAgICAgaWYgKChib3RUb3RhbCA8IDIgfHwgYm90VG90YWwgPCAzICYmIGJvdERhdGEuYWJYUEJvdCAhPSBudWxsKSAmJiBhYkdyaWRGb2N1cykgCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXREaW1lbnNpb24gPSBhYkdyaWRGb2N1cy5kaW1lbnNpb247CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRhcmdldFBvc2l0aW9uID0geyBbdGFyZ2V0RGltZW5zaW9uXTogdHJ1ZSwgW3RhcmdldERpbWVuc2lvbiArICJYIl06IGFiR3JpZEZvY3VzLnBvc2l0aW9uLngsIFt0YXJnZXREaW1lbnNpb24gKyAiWSJdOiBhYkdyaWRGb2N1cy5wb3NpdGlvbi55IH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBiID0gY3JlYXRlKG5ld0JvdC50YWdzLCB0YXJnZXRQb3NpdGlvbiwgYWJJRE9yaWdpbik7CgogICAgICAgICAgICBpZE1hcC5zZXQoYm90RGF0YVtwcm9wZXJ0eV0uaWQsIGIuaWQpOwogICAgICAgICAgICBuZXdCb3RzLnB1c2goYik7CgogICAgICAgICAgICBpZiAoYi50YWdzLmNyZWF0b3IgPT0gdGhpc0JvdC5pZCkgCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGIudGFncy5jcmVhdG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXRjaCAoZXJyb3IpIAogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS5sb2coImludmFsaWQgYm90IiwgZXJyb3IpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgCiAgICB7CiAgICAgICAgY29uc29sZS5sb2coInNraXBwZWQgYm90OiAiICsgbmV3Qm90KTsKICAgIH0KfQoKLy9hcnJheSBvZiB0YWcgcmVsYXRpb25zaGlwcyB0byBiZSBwcmVzZXJ2ZWQKbGV0IGxpbmtUYWdzID0gWyJsaW5rIiwgImNyZWF0b3IiLCAiY29uZmlnQm90IiwgImxpbmVUbyIsICJ0cmFuc2Zvcm1lciJdOwoKLy90aGlzIGxvb3AgY29udGFpbnMgdGhlIGxvZ2ljIGZvciBwcmVzZXJ2aW5nIHRoZSBsaW5rVGFncwpmb3IgKGxldCBuZXdCb3Qgb2YgbmV3Qm90cykgCnsKICAgIGZvciAobGV0IHRhZyBvZiBsaW5rVGFncykgCiAgICB7CiAgICAgICAgbGV0IHZhbHVlID0gbmV3Qm90LnRhZ3NbdGFnXTsKCiAgICAgICAgaWYgKHRhZyA9PSAiY3JlYXRvciIpIAogICAgICAgIHsKICAgICAgICAgICAgdmFsdWUgPSBuZXdCb3QudGFncy5vbGRDcmVhdG9yOwogICAgICAgICAgICBuZXdCb3QudGFncy5vbGRDcmVhdG9yID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUJvdExpbmtzKG5ld0JvdCwgaWRNYXApOwoKICAgICAgICBpZiAodmFsdWUpIAogICAgICAgIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSAKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGV0IG5ld1ZhbHVlID0gdmFsdWUubWFwKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWRNYXAuZ2V0KGlkKSB8fCBpZDsKICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSAKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29uc3QgbmV3SUQgPSBpZE1hcC5nZXQodmFsdWUpOwoKICAgICAgICAgICAgICAgIGlmIChuZXdJRCkgCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3SUQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8vdG9hc3RzIGZvciBoYXRjaGVzLCBidXQgb25seSBvbiBidWlsZGVyCmlmIChjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUgPT0gbnVsbCAmJiAhY29uZmlnQm90LnRhZ3MucGggJiYgYnVpbGRlclZlcnNpb24gPT0gImJ1aWxkZXIiKSAKewogICAgb3MudG9hc3QoImhhdGNoZWQgIiArIG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uKTsKfQoKaWYgKG9yaWdpbikKewogICAgbGV0IGFiRWdnID0ge307CgogICAgYWJFZ2cuYWIgPSB0cnVlOwogICAgYWJFZ2cuYWJFZ2cgPSB0cnVlOwogICAgLy9hYkVnZy5zcGFjZSA9ICJsb2NhbCI7CiAgICBhYkVnZy5hYklnbm9yZSA9IHRydWU7CiAgICBhYkVnZy5vcmlnaW5fYWIgPSBvcmlnaW47CiAgICBhYkVnZy5vcmlnaW5fdmVyc2lvbiA9IHZlcnNpb247CiAgICBhYkVnZy5vcmlnaW5fcmVjb3JkID0gdGhhdC5yZWNvcmQ7CiAgICBhYkVnZy5mb3JtID0gImVnZyI7CiAgICBhYkVnZy5sYWJlbCA9IG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uOwogICAgYWJFZ2cuYWJYID0gZ2V0Qm90cygiYWIiKS5sZW5ndGggKiAxLjU7CgogICAgY3JlYXRlKGFiRWdnKTsKfQoKLy9hZGRpdGlvbmFsIGhhdGNoIGRhdGEKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47CgovL2NoZWNrIGFuZCBleGVjdXRlIG9uUHJlSGF0Y2ggY29kZQpmb3IgKGNvbnN0IGhhdGNoaW5nQm90IG9mIG5ld0JvdHMpCnsKICAgIGlmIChoYXRjaGluZ0JvdC50YWdzLm9uUHJlSGF0Y2gpCiAgICB7CiAgICAgICAgdHJ5CiAgICAgICAgewogICAgICAgICAgICBhd2FpdCBoYXRjaGluZ0JvdC5vblByZUhhdGNoKHthYjogb3JpZ2luLCB2ZXJzaW9uOiB2ZXJzaW9ufSk7CiAgICAgICAgfQogICAgICAgIGNhdGNoCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgb25QcmVIYXRjaCBub3QgdmFsaWQgb24gYm90ICR7aGF0Y2hpbmdCb3QuaWR9YCk7CiAgICAgICAgfQogICAgfQp9CgovL2luaXRpYWwgYm9vdCBsb2dpYyBXSEFUIElTIFRISVM/Pz8KaWYgKGluaXRpYWxCb290KSAKewogICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBvcmlnaW47Cn0KCi8vb25FZ2dIYXRjaCBmb3IgYWxsIGp1c3QgaGF0Y2hlZCBib3RzCndoaXNwZXIobmV3Qm90cywgIm9uRWdnSGF0Y2giLCB7YWI6IG9yaWdpbiwgdmVyc2lvbjogdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGVnZ1BhcmFtZXRlcnM6IHRoYXQuZWdnUGFyYW1ldGVyc30pOwoKLy9vbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQWJBZGRlZCIsIHthYjogb3JpZ2luLCB2ZXJzaW9uOiB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdH0pOwoKcmV0dXJuOycAjomFiASJAghyZW1lbWJlcgIEAI6JhYgEoyMo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAjomFiASJAglvbkFiQWRkZWQCBACOiYWIBMojlAFALy9zaG91dCgib25BYkFkZGVkIiwge2FiOiBvcmlnaW4sIHZlcnNpb246IHZlcnNpb259KTsKCmNvbnNvbGUubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyB0aGF0LmFiLCAidmVyc2lvbjogIiArIHRoYXQudmVyc2lvbik7JwCOiYWIBIkCCGFiSWdub3JlAgQAjomFiATfJAR0cnVlKACOiYWIBIkCDGFiQm90VmVyc2lvbgF9hAMnAI6JhYgEiQIHYWJTaGVsbAIEAI6JhYgE5SQEdHJ1ZScBBGJvdHMkNDAyY2NiMTYtZDQwMi00NDA0LWIxYWQtN2FkNzNjYzI5NzcyAScAjomFiATqJAdBcHAuY3NzAgQAjomFiATrJNcQOnJvb3QgewogIC0tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICAtLW9uLWFiLWNvbnNvbGUtYmc6ICMyMTI1Mjk7Cn0KLyogRGFyayBtb2RlIHN1cHBvcnQgKi8KQG1lZGlhIChwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykgewogIDpyb290IHsKICAgIC0tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAgIC0tb24tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICB9Cn0KCi5hYi1jb25zb2xlIHsKICB3aWR0aDogMTAwdnc7CiAgaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogIHBhZGRpbmc6IDAgMXJlbTsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpIGJyaWdodG5lc3MoMjAwJSk7CiAgYW5pbWF0aW9uLW5hbWU6IHNsaWRlLWFwcC1pbjsKICBhbmltYXRpb24tZHVyYXRpb246IDAuNXM7CiAgb3ZlcmZsb3cteTogaGlkZGVuOwogIHotaW5kZXg6IDE7Cn0KCi5hYi1jb25zb2xlOjphZnRlciB7CiAgY29udGVudDogIiI7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgcG9zaXRpb246IGFic29sdXRlOwogIHRvcDogMDsKICBsZWZ0OiAwOwogIHJpZ2h0OiAwOwogIGJvdHRvbTogMDsKICBvcGFjaXR5OiAwLjk7CiAgei1pbmRleDogMDsKfQoKQGtleWZyYW1lcyBzbGlkZS1hcHAtaW4gewogIGZyb20gewogICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogY3ViaWMtYmV6aWVyKC42LDAsLjc5LDEuMDMpOwogICAgLyogdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDExMCUpOyAqLwogICAgaGVpZ2h0OiAwcHg7CiAgICBtaW4taGVpZ2h0OiAwcHg7CiAgfQoKICB0byB7CiAgICBoZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICAgIG1pbi1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICB9Cn0KCi5hYi1jb25zb2xlID4gZGl2IHsKICB6LWluZGV4OiAxOwogIHBvc2l0aW9uOiByZWxhdGl2ZQp9CgouYWItY29uc29sZS1sb2cgewogIG92ZXJmbG93LXk6IGF1dG87CiAgZmxleC1ncm93OiAxOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbi1yZXZlcnNlOwp9CgouYWItY29uc29sZS1tZXNzYWdlIHsKICBtYXJnaW4tYm90dG9tOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmFiLWNvbnNvbGUtaW5wdXQgewogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICB3aWR0aDogMTAwJTsKICByZXNpemU6IHZlcnRpY2FsOwogIGJvcmRlci1yYWRpdXM6IDJweDsKICBwYWRkaW5nOiAwIDAuNXJlbTsKICBsaW5lLWhlaWdodDogMS44cmVtOwoKICAvKiBSZXNldCB0ZXh0YXJlYSBzdHlsZXMgKi8KICBib3JkZXI6IG5vbmU7CiAgb3V0bGluZTogbm9uZTsKICAtd2Via2l0LWFwcGVhcmFuY2U6IG5vbmU7CiAgLXdlYmtpdC1ib3gtc2hhZG93OiBub25lOwogIC1tb3otYm94LXNoYWRvdzogbm9uZTsKICBib3gtc2hhZG93OiBub25lOwp9CgouYWItY29uc29sZS1pbnB1dDpmb2N1cyB7CiAgYm9yZGVyLWJvdHRvbS13aWR0aDogMnB4ICFpbXBvcnRhbnQ7CiAgYm9yZGVyLWJvdHRvbS1jb2xvcjogIzNlODJmOCAhaW1wb3J0YW50OwogIGJvcmRlci1ib3R0b20tc3R5bGU6IHNvbGlkOwp9CgouY29uc29sZS1zZW5kLWJ0biB7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwoJYm9yZGVyOiBub25lOwoJZm9udDogaW5oZXJpdDsKCWN1cnNvcjogcG9pbnRlcjsKCW91dGxpbmU6IGluaGVyaXQ7CiAgcGFkZGluZzogMCAxcmVtOwp9CgouY29uc29sZS1zZW5kLWJ0biA+IHNwYW4gewogIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgzcHgpCn0nAI6JhYgE6iQMUmVzaXplSGFuZGxlAgQAjomFiATDNboNQGNvbnN0IHsgdXNlRWZmZWN0LCB1c2VTdGF0ZSwgdXNlUmVmIH0gPSBvcy5hcHBIb29rcwpjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IFJlc2l6ZUhhbmRsZSA9ICgpID0+IHsKICAgIGNvbnN0IFtoZWlnaHQsIHNldEhlaWdodF0gPSB1c2VTdGF0ZShpbml0aWFsSGVpZ2h0ICsgb2Zmc2V0KQogICAgY29uc3QgW2xpc3RlbmluZywgc2V0TGlzdGVuaW5nXSA9IHVzZVN0YXRlKGZhbHNlKQoKICAgIGNvbnN0IHVwZGF0ZUhlaWdodCA9ICgpID0+IHsKICAgICAgICBpZiAobGlzdGVuaW5nKSB7CiAgICAgICAgICAgIHNldEhlaWdodChncmlkUG9ydGFsQm90LnRhZ3MucG9pbnRlclBpeGVsWSArIDYgKyBNYXRoLnJhbmRvbSgpLzEwMDApOwoKICAgICAgICAgICAgaWYoaGVpZ2h0ID4gZ3JpZFBvcnRhbEJvdC50YWdzLnBpeGVsSGVpZ2h0IC8gMikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2V0SGVpZ2h0KChncmlkUG9ydGFsQm90LnRhZ3MucGl4ZWxIZWlnaHQgLyAyKSAtIDYpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGxpc3RlbmluZykgewogICAgICAgICAgICB1cGRhdGVIZWlnaHQoKQogICAgICAgIH0KICAgIH0sIFtsaXN0ZW5pbmddKQoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKCFsaXN0ZW5pbmcpIHJldHVybjsKCiAgICAgICAgaWYgKGhlaWdodCA8IDgwKSB7CiAgICAgICAgICAgIHNldExpc3RlbmluZyhmYWxzZSk7CiAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QudGFncy5wb3J0YWxab29tYWJsZSA9IHRydWU7CiAgICAgICAgICAgIHNob3V0KCdoaWRlQ29uc29sZScpOwogICAgICAgICAgICBtYXNrcy5vcGVuID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGdyaWRQb3J0YWxCb3QudGFncy5wb2ludGVyUGl4ZWxZICsgNyA+PSBncmlkUG9ydGFsQm90LnRhZ3MucGl4ZWxIZWlnaHQgLyAyKXsKICAgICAgICAgICBzZXRMaXN0ZW5pbmcoZmFsc2UpOwogICAgICAgIH0KCiAgICAgICAgb3Muc2xlZXAoZHJhZ0ludGVydmFsKS50aGVuKCgpID0+IHsKICAgICAgICAgICAgdXBkYXRlSGVpZ2h0KCk7CiAgICAgICAgfSkKICAgIH0sIFtoZWlnaHRdKQoKCiAgICByZXR1cm4gKDw+CiAgICAgICAgPHN0eWxlPntgOnJvb3Qgey0tYWItY29uc29sZS1oZWlnaHQ6ICR7aGVpZ2h0fXB4fWB9PC9zdHlsZT4KICAgICAgICA8ZGl2CiAgICAgICAgICAgIG9uUG9pbnRlckRvd249eygpID0+IHNldExpc3RlbmluZyh0cnVlKX0KICAgICAgICAgICAgb25Qb2ludGVyVXA9eygpID0+IHNldExpc3RlbmluZyhmYWxzZSl9CiAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICB3aWR0aDogJzEwMCUnLAogICAgICAgICAgICAgICAgaGVpZ2h0OiAnMjRweCcsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJzI0cHgnLAogICAgICAgICAgICAgICAgbGluZUhlaWdodDogJzIycHgnLAogICAgICAgICAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJywKICAgICAgICAgICAgICAgIGN1cnNvcjogJ2dyYWInLAogICAgICAgICAgICAgICAgdXNlclNlbGVjdDogJ25vbmUnLAogICAgICAgICAgICB9fQogICAgICAgID4KICAgICAgICAgICAg4oCUCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBSZXNpemVIYW5kbGUKJwCOiYWIBOokCmFiSURPcmlnaW4CBACOiYWIBPxCB2FiTG9nVjInAI6JhYgE6iQGZ2V0QXBwAgQAjomFiASEQ+kLQGNvbnN0IHsgdXNlRWZmZWN0LCB1c2VTdGF0ZSB9ID0gb3MuYXBwSG9va3MKY29uc3QgUmVzaXplSGFuZGxlID0gdGhpc0JvdC5SZXNpemVIYW5kbGUoKQoKY29uc3QgTWVzc2FnZSA9ICh7dGltZXN0YW1wLCBtZXNzYWdlfSkgPT4gewogICAgcmV0dXJuICgKICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlIj4KICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtdGltZXN0YW1wIj4KICAgICAgICAgICAgICAgIHt0aW1lc3RhbXAudG9Mb2NhbGVTdHJpbmcoJ2VuLVVTJywgeyB0aW1lU3R5bGU6ICdtZWRpdW0nIH0pfQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtY29udGVudCI+e21lc3NhZ2V9PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICApCn0KCmNvbnN0IEFwcCA9ICh7ICB9KSA9PiB7CiAgICBjb25zdCBbY29uc29sZUxvZywgc2V0Q29uc29sZUxvZ10gPSB1c2VTdGF0ZSh0aGlzQm90Lm1hc2tzLmhpc3RvcnkpCgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIHNldENvbnNvbGVMb2coWyAuLi50aGlzQm90Lm1hc2tzLmhpc3RvcnkgXSkKICAgIH0KCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIHRoaXNCb3QudmFycy51cGRhdGVMb2cgPSB1cGRhdGVMb2cKICAgICAgICByZXR1cm4gKCgpID0+IHsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZyA9IG51bGwKICAgICAgICB9KQogICAgfSwgW10pCgogICAgcmV0dXJuICg8PgogICAgICAgIDxzdHlsZT57dGFnc1snQXBwLmNzcyddfTwvc3R5bGU+CgogICAgICAgIDxkaXYKICAgICAgICAgICAgaWQ9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZSIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eygpID0+IGdyaWRQb3J0YWxCb3QudGFncy5wb3J0YWxab29tYWJsZSA9IGZhbHNlfQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLmN1cnJlbnRUYXJnZXQuaWQgPT0gImFiLWNvbnNvbGUiKXsKICAgICAgICAgICAgICAgICAgICBncmlkUG9ydGFsQm90LnRhZ3MucG9ydGFsWm9vbWFibGUgPSB0cnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH19CiAgICAgICAgPgoKICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtbG9nIj4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcChtID0+CiAgICAgICAgICAgICAgICAgICAgPE1lc3NhZ2UgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0gbWVzc2FnZT17bS5tZXNzYWdlfSAvPikKICAgICAgICAgICAgICAgIDogPD48Lz59CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPFJlc2l6ZUhhbmRsZSAvPgogICAgICAgIDwvZGl2PgogICAgPC8+KQp9CgpyZXR1cm4gQXBwCicAjomFiATqJAtoaWRlQ29uc29sZQIEAI6JhYgE7k5eQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMAphd2FpdCBvcy51bnJlZ2lzdGVyQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gKScAjomFiATqJANsb2cCBACOiYWIBM1PygNAY29uc3QgbWVzc2FnZSA9IHRoYXQKCi8vIENyZWF0ZSBsb2NhbCBjb3B5IG9mIGhpc3RvcnkgbWFzawp2YXIgX2hpc3RvcnkgPSB0aGlzQm90Lm1hc2tzLmhpc3RvcnkKCi8vIFB1c2ggbWVzc2FnZSBpZiB0aGUgbWFzayBleGlzdGVkCmlmICggQXJyYXkuaXNBcnJheShfaGlzdG9yeSkgKSB7CiAgICBfaGlzdG9yeS51bnNoaWZ0KHsKICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksCiAgICAgICAgbWVzc2FnZQogICAgfSkKCi8vIEluaXRpYWxpemUgdGhlIGFycmF5IGlmIGl0IGRpZG4ndAp9IGVsc2UgewogICAgX2hpc3RvcnkgPSBbewogICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSwKICAgICAgICBtZXNzYWdlCiAgICB9XQp9Cgp0aGlzQm90Lm1hc2tzLmhpc3RvcnkgPSBbIC4uLl9oaXN0b3J5IF0KaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKScAjomFiATqJAtzaG93Q29uc29sZQIEAI6JhYgEmFO0A0Bjb25maWdCb3QubWFza3MudGFnUG9ydGFsID0gbnVsbApjb25maWdCb3QubWFza3MudGFnUG9ydGFsU3BhY2UgPSBudWxsCgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDAKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCkKCmN1cnJlbnRWZXIgKz0gMQptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXIKLy8gR2V0LCByZWdpc3RlciwgYW5kIGNvbXBpbGUgdGhlIGFwcApjb25zdCBBcHAgPSB0aGlzQm90LmdldEFwcCgpCmF3YWl0IG9zLnJlZ2lzdGVyQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCB0aGlzQm90KQpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KQonAI6JhYgE6iQGc3lzdGVtAgQAjomFiATNVhBhYi5zaGVsbC5jb25zb2xlKACOiYWIBOokCGFiSWdub3JlAXgnAI6JhYgE6iQNdG9nZ2xlQ29uc29sZQIEAI6JhYgE31aWAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfSgAjomFiATqJAxhYkJvdFZlcnNpb24BfRInAI6JhYgE6iQEZm9ybQIEAI6JhYgE91cHbm90aGluZycAjomFiATqJAdhYlNoZWxsAgQAjomFiAT/VwR0cnVlJwEEYm90cyQ3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YBJwCOiYWIBIRYBnN5c3RlbQIEAI6JhYgEhVgOYWIuc2hlbGwuc3RvcmUnAI6JhYgEhFgEZm9ybQIEAI6JhYgElFgHbm90aGluZycAjomFiASEWAtkZXNjcmlwdGlvbgIEAI6JhYgEnFg/VGhpcyBza2lsbCBpcyBtZWFudCB0byBiZSBhIGNvbmZpZ3VyYWJsZSBtZWFucyB0byBwdWJsaXNoIGRhdGEuJwCOiYWIBIRYD2FiUHVibGlzaFJlY29yZAIEAI6JhYgE3FiyBkBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nOwpsZXQgcmVjb3JkRGF0YSA9IHRoYXQuZGF0YTsKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CmxldCBlbmRwb2ludCA9IHRoYXQuZW5kcG9pbnQgPyB0aGF0LmVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgppZiAoIXJlY29yZERhdGEpCnsKICAgIHJldHVybiAibm8gZGF0YSBzdXBwbGllZCI7Cn0KCmlmIChwdWJsaWNGYWNpbmcpCnsKICAgIHJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHVzZXJSZWNvcmQsIHJlY29yZE5hbWUsIHJlY29yZERhdGEsIHtlbmRwb2ludDogZW5kcG9pbnQsIG1hcmtlcnM6IFsicHVibGljUmVhZCJdfSk7Cn0KZWxzZQp7ICAgIAogICAgcmVjb3JkRGF0YSA9IGF3YWl0IG9zLnJlY29yZERhdGEodXNlclJlY29yZCwgcmVjb3JkTmFtZSwgcmVjb3JkRGF0YSwge2VuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogW3JlY29yZE5hbWVdfSk7Cn0KCmlmIChyZWNvcmREYXRhLnN1Y2Nlc3MpCnsKICAgIGFiLmxvZyhhYlJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkYXRhIHJlY29yZGVkIHRvICIgKyB1c2VyUmVjb3JkKTsKfQplbHNlCnsKICAgIGFiLmxvZyhhYlJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkYXRhIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIHJlY29yZERhdGE7JwCOiYWIBIRYDWFiUHVibGlzaEZpbGUCBACOiYWIBI9f2QVAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBmaWxlID0gdGhhdC5maWxlOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGVOYW1lOwpsZXQgbWltZVR5cGUgPSB0aGF0Lm1pbWVUeXBlOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgppZiAoIWZpbGUpCnsKICAgIHJldHVybiAibm8gZmlsZSBzdXBwbGllZCI7Cn0KCmxldCBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKICAgIAppZiAoIWZpbGVVcGxvYWQuc3VjY2VzcykgCnsKICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbih1c2VyUmVjb3JkKTsKCiAgICBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKfQoKaWYgKGZpbGVVcGxvYWQuc3VjY2VzcykKewogICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgcmVjb3JkZWQgdG8gIiArIHVzZXJSZWNvcmQpOwp9CmVsc2UKewogICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgZmFpbGVkIHRvIHJlY29yZCIpOwp9CgpyZXR1cm4gZmlsZVVwbG9hZDsnAI6JhYgEhFgQYWJDb3JlTWVudUFjdGlvbgIEAI6JhYgE6WRNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAI6JhYgEhFgLb25TdG9yZU1lbnUCBACOiYWIBLdl015AbGV0IHBvc3NpYmxlUHVibGlzaEJvdCA9IGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXM7Cgpjb25zb2xlLmxvZyhwb3NzaWJsZVB1Ymxpc2hCb3QpCgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgdXVhYiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MudXVhYiA/IHRydWUgOiBmYWxzZTsKCgpjb25zdCBkZWZhdWx0cyA9IHsKICAgIGFiTWVudTogdHJ1ZSwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbWFuYWdlcjogIvCflJciICsgdGhpc0JvdC5pZCwKICAgIG1hbmlmZXN0YXRpb246IHRhZ3MubWFuaWZlc3RhdGlvbiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICIwcHgiLCAibWFyZ2luLXRvcCI6ICIwcHgifWAKfTsKCi8vIENyZWF0ZSBkb3dubG9hZCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICBsYWJlbDogImRvd25sb2FkIiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICI5cHggOXB4IDlweCA5cHgiLCAibWFyZ2luLXRvcCI6ICIzcHgifWAsCiAgICBmb3JtQWRkcmVzczogImdldF9hcHAiLAogICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYkRvd25sb2FkKCk7YAp9KTsKCmlmICghYXV0aEJvdCkKewogICAgLy8gQ3JlYXRlIGxvZ2luIG1lc3NhZ2UKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICAgICAgbGFiZWw6ICJwbGVhc2Ugc2lnbiBpbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIsCiAgICAgICAgb25DbGljazogYEAgb3MucmVxdWVzdEF1dGhCb3QoKWAKICAgIH0pOwoKICAgIHJldHVybjsKfQplbHNlIGlmIChhdXRoQm90LnRhZ3Muc3Vic2NyaXB0aW9uVGllciA9PSAiRnJlZVBsYXkiKQp7CiAgICAvLyBDcmVhdGUgdXBncmFkZSBzdWJzY3JpcHRpb24gYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJwbGVhc2UgdXBncmFkZSB5b3VyIHN1YnNjcmlwdGlvbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIKICAgIH0pOwoKICAgIHJldHVybjsKfQoKaWYgKCF1dWFiKQp7CiAgICBsZXQgdXNlclN0dWRpb3MgPSBjb25maWdCb3QudGFncy51c2VyX3N0dWRpb3M7CgogICAgaWYgKCF1c2VyU3R1ZGlvcykKICAgIHsKICAgICAgICB1c2VyU3R1ZGlvcyA9IGF3YWl0IG9zLmxpc3RVc2VyU3R1ZGlvcygpOwogICAgfQogICAgCiAgICBpZiAodXNlclN0dWRpb3Muc3VjY2VzcykKICAgIHsKICAgICAgICBjb25zdCBhY3RpdmVTdHVkaW8gPSB1c2VyU3R1ZGlvcy5zdHVkaW9zLmZpbmRJbmRleChzdHVkaW8gPT4gc3R1ZGlvLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKTsKICAgICAgICBsZXQgYmFzZVN0dWRpbyA9IGF1dGhCb3QuaWQ7CgogICAgICAgIGlmIChiYXNlU3R1ZGlvID09IGF1dGhCb3QuaWQpCiAgICAgICAgewogICAgICAgICAgICBiYXNlU3R1ZGlvID0gInBsYXllciI7CiAgICAgICAgfQoKICAgICAgICBpZiAoYWN0aXZlU3R1ZGlvID09IC0xICYmIGJhc2VTdHVkaW8gIT0gInBsYXllciIpCiAgICAgICAgewogICAgICAgICAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGJhc2VTdHVkaW87CiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvICYmICFhY3RpdmVTdHVkaW8pCiAgICAgICAgewogICAgICAgICAgICBjb25zdCBzdHVkaW9NYXRjaCA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQoKICAgICAgICAgICAgaWYgKHN0dWRpb01hdGNoICE9IC0xKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBiYXNlU3R1ZGlvID0gYmFzZVN0dWRpbzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc3R1ZGlvTGFiZWwgPSBhY3RpdmVTdHVkaW8gPT0gLTEgPyBiYXNlU3R1ZGlvIDogdXNlclN0dWRpb3Muc3R1ZGlvc1thY3RpdmVTdHVkaW9dLmRpc3BsYXlOYW1lOwoKICAgICAgICAvLyBDcmVhdGUgc3R1ZGlvIHNlbGVjdCBidXR0b24KICAgICAgICBjb25zdCBzdHVkaW9EaXNwbGF5QnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICAgICAgbGFiZWw6ICJzdHVkaW89IiArIHN0dWRpb0xhYmVsLAogICAgICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNSwKICAgICAgICAgICAgc3R1ZGlvSW5mb3JtYXRpb246IHVzZXJTdHVkaW9zLAogICAgICAgICAgICBmb3JtQWRkcmVzczogImludmVudG9yeV8yIiwKICAgICAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5zdHVkaW9TZWxlY3QodGFncy5zdHVkaW9JbmZvcm1hdGlvbik7YAogICAgICAgIH0pOwoKICAgICAgICBtYXNrcy5zdHVkaW9TZWxlY3RCdXR0b24gPSBnZXRMaW5rKHN0dWRpb0Rpc3BsYXlCdXR0b24pOwogICAgfQoKICAgIC8vIENyZWF0ZSBwdWJsaXNoIGxhYmVsIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGxhYmVsOiAicHVibGlzaCBwYXR0ZXJuIiwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEsCiAgICAgICAgbGFiZWxBbGlnbm1lbnQ6ICJjZW50ZXIiLAogICAgICAgIGZvcm1BZGRyZXNzOiBudWxsLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICI5cHggOXB4IDBweCAwcHgiLCAibWFyZ2luLXRvcCI6ICI2cHgifWAsCiAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICBzY2FsZVk6IDAuNzUKICAgIH0pOwogICAgCiAgICAvLyBDcmVhdGUgZW5jcnlwdCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICAgICAgbGFiZWw6ICJlbmNyeXB0IiwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgICAgICBlbmNyeXB0U3RhdGU6IGZhbHNlLAogICAgICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MuZW5jcnlwdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IHRydWU7CiAgICAgICAgfWAKICAgIH0pOwoKICAgIC8vIENyZWF0ZSBwdWJsaWMgYnV0dG9uCiAgICBpZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpCiAgICB7CiAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gZmFsc2U7CiAgICAgICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICAgICAgYWJNZW51U29ydE9yZGVyOiAyLAogICAgICAgICAgICBsYWJlbDogImlzUHVibGljIiwKICAgICAgICAgICAgbGFiZWxBbGlnbm1lbnQ6ICJsZWZ0IiwKICAgICAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICAgICAgICAgIHB1YmxpY1N0YXRlOiBmYWxzZSwKICAgICAgICAgICAgb25DbGljazogYEAgaWYodGFncy5wdWJsaWNTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSB0cnVlOwogICAgICAgICAgICB9YAogICAgICAgIH0pOwogICAgfQoKICAgIC8vIENyZWF0ZSBjdXJyZW50IHZlcnNpb24gYnV0dG9uCiAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICI5cHggOXB4IDBweCAwcHgiLCAibWFyZ2luLXRvcCI6ICI2cHgifWAsCiAgICAgICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogLTYsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3giLAogICAgICAgIGxhYmVsOiAiY3VycmVudCB2ZXJzaW9uIiwKICAgICAgICBvdGhlck9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0aGlzQm90LmlkKXtyZXR1cm47fQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICBgLAogICAgICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAnY3VycmVudCB2ZXJzaW9uJzsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwoKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwoKICAgICAgICAgICAgc2hvdXQoIm90aGVyT3B0aW9uQ2xpY2siLCB0aGlzQm90LmlkKTsKICAgICAgICBgCiAgICB9KTsKCiAgICAvLyBDcmVhdGUgZmVlZGJhY2sgdmVyc2lvbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgICAgICBidXR0b25TdGF0ZTogbnVsbCwKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogLTUsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICAgICAgbGFiZWw6ICJmZWVkYmFjayB2ZXJzaW9uIiwKICAgICAgICBvdGhlck9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0aGlzQm90LmlkKXtyZXR1cm47fQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICBgLAogICAgICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAnZmVlZGJhY2sgdmVyc2lvbic7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKCiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gImZlZWRiYWNrIjsKCiAgICAgICAgICAgIHNob3V0KCJvdGhlck9wdGlvbkNsaWNrIiwgdGhpc0JvdC5pZCk7CiAgICAgICAgYAogICAgfSk7CgogICAgLy8gQ3JlYXRlIHN0YWJsZSB2ZXJzaW9uIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICIwcHggMHB4IDhweCA4cHgiLCAibWFyZ2luLXRvcCI6ICIwcHgifWAsCiAgICAgICAgYnV0dG9uU3RhdGU6IG51bGwsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IC00LAogICAgICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgICAgIGxhYmVsOiAic3RhYmxlIHZlcnNpb24iLAogICAgICAgIG90aGVyT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRoaXNCb3QuaWQpe3JldHVybjt9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgIGAsCiAgICAgICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICdzdGFibGUgdmVyc2lvbic7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKCiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gInN0YWJsZSI7CgogICAgICAgICAgICBzaG91dCgib3RoZXJPcHRpb25DbGljayIsIHRoaXNCb3QuaWQpOwogICAgICAgIGAKICAgIH0pOwp9CgoKaWYgKHV1YWIpCnsKICAgIC8vIENyZWF0ZSBwdWJsaXNoIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogNCwKICAgICAgICBmb3JtQWRkcmVzczogInFyX2NvZGVfc2Nhbm5lciIsCiAgICAgICAgbGFiZWw6ICJwdWJsaXNoIGFiIiwKICAgICAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudXVhYlNjYW4gPSB0cnVlOwogICAgICAgICAgICAgICAgb3Mub3BlblFSQ29kZVNjYW5uZXIoKTsKICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJwbGVhc2Ugc2NhbiB5b3VyIHByYWN0aWNlIHBlcm1pdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJxciBjb2RlIHNjYW4gbm90IHN1cHBvcnRlZCBvbiB0aGlzIGRldmljZSIpOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudXVhYlNjYW4gPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwogICAgICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKICAgICAgICBgCiAgICB9KTsKfQplbHNlCnsKICAgIC8vIENyZWF0ZSBwdWJsaXNoIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogNCwKICAgICAgICBmb3JtQWRkcmVzczogImVnZyIsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgeyJib3JkZXItcmFkaXVzIjogIjBweCAwcHggOXB4IDlweCIsICJtYXJnaW4tdG9wIjogIjBweCJ9YCwKICAgICAgICBmb3JtOiAiaW5wdXQiLAogICAgICAgIG1lbnVJdGVtU2hvd1N1Ym1pdFdoZW5FbXB0eTogdHJ1ZSwKICAgICAgICB0YXJnZXRCb3Q6IGdldExpbmsocG9zc2libGVQdWJsaXNoQm90KSwKICAgICAgICBtZW51SXRlbVRleHQ6ICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzCiAgICAgICAgICAgICAgICAgICAgICA/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCCiAgICAgICAgICAgICAgICAgICAgICA6IGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMuaWQsCiAgICAgICAgb25TdWJtaXQ6IGBACiAgICAgICAgICAgIGlmICh0aGF0LnRleHQgPT0gbnVsbCAmJiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiAhbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhhdC50ZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CiAgICAgICAgICAgIGNvbnN0IGNvbmZpcm1QdXNoID0gYXdhaXQgb3Muc2hvd0NvbmZpcm0oewogICAgICAgICAgICAgICAgdGl0bGU6ICJjb25maXJtIHB1Ymxpc2giLAogICAgICAgICAgICAgICAgY29udGVudDogInB1Ymxpc2ggIiArIHRoYXQudGV4dCArICIgdG8gIiArIHRhcmdldFN0dWRpbyArICI/IiwKICAgICAgICAgICAgICAgIGNvbmZpcm1UZXh0OiAicHVibGlzaCIsCiAgICAgICAgICAgICAgICBjYW5jZWxUZXh0OiAiY2FuY2VsIgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmICghY29uZmlybVB1c2gpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCA9IHRydWU7CgogICAgICAgICAgICBpZiAodGhhdC50ZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaEFCKHthYjogdGhhdC50ZXh0LCBtYW51YWxQdWJsaXNoOiB0cnVlLCBib3Q6IGxpbmtzLnRhcmdldEJvdH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3MudG9hc3QoImFiIG5vdCBzcGVjaWZpZWQiKTsKICAgICAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIGAKICAgIH0pOwp9CgoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCnsKICAgIC8vIENyZWF0ZSBjb3B5IHRvIGNsaXBib2FyZCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDgsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgeyJib3JkZXItcmFkaXVzIjogIjlweCA5cHggOXB4IDlweCIsICJtYXJnaW4tdG9wIjogIjZweCJ9YCwKICAgICAgICBsYWJlbDogImNvcHkgdG8gY2xpcGJvYXJkIiwKICAgICAgICBmb3JtQWRkcmVzczogImZpbGVfY29weSIsCiAgICAgICAgdGFyZ2V0Qm90OiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQm90Rm9jdXMsCiAgICAgICAgb25DbGljazogYEAgbGV0IHNlbGVjdGVkQm90ID0gbGlua3MudGFyZ2V0Qm90OwogICAgICAgICAgICBsZXQgcHJlcHBlZEJvdCA9IEpTT04uc3RyaW5naWZ5KHNlbGVjdGVkQm90KTsKICAgICAgICAgICAgbGV0IHN0YXRlID0ge30KCiAgICAgICAgICAgIHN0YXRlW2FiSW5zdE1lbW9yeS50YWdzLmFiRm9jdXNEYXRhXSA9IHNlbGVjdGVkQm90OwoKICAgICAgICAgICAgbGV0IG5ld0ZpbGUgPSB7fQogICAgICAgICAgICBuZXdGaWxlLnZlcnNpb24gPSAxOwogICAgICAgICAgICBuZXdGaWxlLnN0YXRlID0gc3RhdGU7CgogICAgICAgICAgICB2YXIgZm9ybWF0dGVkRmlsZSA9IEpTT04uc3RyaW5naWZ5KG5ld0ZpbGUpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZm9ybWF0dGVkRmlsZSk7CgogICAgICAgICAgICBvcy50b2FzdCgiYm90IGNvcGllZCB0byBjbGlwYm9hcmQiKTsKCiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwogICAgICAgIGAKICAgIH0pOwp9CmVsc2UgaWYgKCF1dWFiKQp7CiAgICAvLyBDcmVhdGUgc2NhbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEwLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICI5cHggOXB4IDlweCA5cHgiLCAibWFyZ2luLXRvcCI6ICIzcHgifWAsCiAgICAgICAgbGFiZWw6ICJzY2FuIiwKICAgICAgICBmb3JtQWRkcmVzczogInFyX2NvZGVfc2Nhbm5lciIsCiAgICAgICAgb25DbGljazogYEAgY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSB0cnVlOyBvcy5vcGVuUVJDb2RlU2Nhbm5lcigpO2AKICAgIH0pOwoKICAgIC8vTkVFRCBUTyBVUERBVEUKICAgIGlmIChjb25maWdCb3QudGFncy5naWcpCiAgICB7CiAgICAgICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICAgICAgYWJNZW51U29ydE9yZGVyOiAtNSwKICAgICAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgeyJib3JkZXItcmFkaXVzIjogIjlweCA5cHggOXB4IDlweCIsICJtYXJnaW4tdG9wIjogIjNweCJ9YCwKICAgICAgICAgICAgbGFiZWw6ICJzdWJtaXQgZ2lnIiwKICAgICAgICAgICAgZm9ybUFkZHJlc3M6ICJzZW5kIiwKICAgICAgICAgICAgb25DbGljazogYEBzaG91dCgiYWJDb2xsYWJTdWJtaXQiKWAKICAgICAgICB9KTsKICAgIH0KfQoKbGV0IGhvc3RCdXR0b24gPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDUwLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgZm9ybUFkZHJlc3M6ICJncm91cF9hZGQiLAogICAgY29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsZWFybjogdGFncy5sZWFybiwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgb25DbGljazogYEAgbGlua3MubGVhcm4uYWJDcmVhdGVIb3N0KHRoaXNCb3QpOwogICAgaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkKICAgIHsKICAgICAgICB0YWdzLmxhYmVsID0gJ2dlbmVyYXRpbmcgY29kZSBub3cnOwogICAgfWAKfTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJqb2luIGNvZGU6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMCwzKSArICItIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElELnN1YnN0cmluZygzKTsKfQplbHNlCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiZ2VuZXJhdGUgam9pbiBjb2RlIjsKfQoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oaG9zdEJ1dHRvbik7Ly9nZW5lcmF0ZSBhIGhvc3QgYnV0dG9uJwCOiYWIBIRYDmFiQ29yZU1lbnVJY29uAgQAjomFiAT3wwEJaW9zX3NoYXJlJwCOiYWIBIRYD2FiQ29yZU1lbnVMYWJlbAIEAI6JhYgEgcQBBXNoYXJlJwCOiYWIBIRYE2FiQ29yZU1lbnVTb3J0T3JkZXICBACOiYWIBIfEAQEzJwCOiYWIBIRYCHJlbWVtYmVyAgQAjomFiASJxAEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAjomFiASEWAthYlB1Ymxpc2hBQgIEAI6JhYgEsMQB+ydALy9zaG91dCgiYWJQdWJsaXNoQUIiLCB7YWI6ICIiLCBrZXk6ICIiLCB0YXJnZXQ6ICIifSk7CmFiLmxvZyhhYlJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBwdWJsaXNoaW5nICIgKyB0aGF0LmFiKTsKCmxldCBwcm9ncmVzc0J1dHRvbjsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgovL2NsZWFyIGFiIGJ1aWxkZXIKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24pCnsKICAgIGlmIChsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KQogICAgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCi8vcHJvZ3Jlc3MgYmFyIGZvciBtYW51YWwgcHVibGlzaGluZyBjb25maXJtYXRpb24KaWYgKGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2gpCnsKICAgIHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MuaW5wdXQuYWJQcm9ncmVzc0JhcihgdXBsb2FkaW5nICR7dGhhdC5hYn1gKTsKfQoKLy9hYiB2YXJpYWJsZXMKbGV0IGFiSUQgPSB0aGF0LmFiOwpsZXQga2V5ID0gdGhhdC5rZXk7CmxldCB0YXJnZXQgPSB0aGF0LnRhcmdldCA/IHRoYXQudGFyZ2V0IDogdGhhdC5ib3Q7CmxldCByZXR1cm5UeXBlID0gdGhhdC5yZXR1cm5UeXBlOwpsZXQgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmcgPz8gY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nOwpsZXQgc3RhdGUgPSB7fTsKbGV0IGZvcm1hdHRlZEZpbGUgPSB7fTsKCmNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IG51bGw7CgovL3RoaXMgbG9naWMgZm9ybWF0cyB0aGUgc3BlY2lmaWVkIGJvdHMgYW5kIHBhY2thZ2VzIHRoZW0gZm9yIHB1Ymxpc2hpbmcKaWYgKCFBcnJheS5pc0FycmF5KHRhcmdldCkgJiYgdGFyZ2V0ICE9IG51bGwgJiYgdGFyZ2V0ICE9IHVuZGVmaW5lZCkKewoKfQplbHNlIGlmICghdGFyZ2V0IHx8IHRhcmdldC5sZW5ndGggPCAxKQp7CiAgICB0YXJnZXQgPSBnZXRCb3RzKGJ5TW9kKHtzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwoKICAgIGlmICh0YXJnZXQubGVuZ3RoIDwgMSkKICAgIHsKICAgICAgICBvcy50b2FzdCgiTm8gYm90cyBmb3VuZCB0byBwdWJsaXNoIik7CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vdGhpcyBsb2dpYyBoYW5kbGVzIGdlbmVyYXRpbmcgYSBrZXkgZm9yIGVuY3J5cHRpb24gKG9wdGlvbmFsKQppZiAoY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbikKewogICAgbGV0IGtleUNoZWNrOwoKICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwoKICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgIHRpdGxlOiAnZW50ZXIgYSBzZWNyZXQga2V5JwogICAgfSk7CgogICAgaWYgKGtleSkKICAgIHsKICAgICAgICBrZXlDaGVjayA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdjb25maXJtIHNlY3JldCBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgaWYgKGtleSAhPSBrZXlDaGVjaykgewogICAgICAgIGlmICgha2V5Q2hlY2spCiAgICAgICAgewogICAgICAgICAgICBvcy50b2FzdCgibm8ga2V5IGVudGVyZWQiKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgb3MudG9hc3QoImtleXMgZG8gbm90IG1hdGNoIik7CiAgICAgICAgfQoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL2Zvcm1hdHRpbmcgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIAp7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhcmdldC5sZW5ndGg7IGkrKykgewogICAgICAgIGxldCBjdXJyZW50Qm90SUQgPSB0YXJnZXRbaV0uaWQ7CiAgICAgICAgbGV0IGN1cnJlbnRCb3QgPSB0YXJnZXRbaV07CiAgICAgICAgCiAgICAgICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3Q7CiAgICB9Cn0KZWxzZSAKewogICAgc3RhdGVbdGFyZ2V0LmlkXSA9IHRhcmdldDsKfQoKLy9jaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYW5kIHJldHVybnMgZGF0YSBmb3IgcHJldmlvdXNseSBwdWJsaXNoZWQgYWIncwpsZXQgZWdnQ2hlY2sgPSBhd2FpdCB0aGlzQm90LmFiUHJldmlvdXNFZ2dDaGVjayh7YWJJRDogYWJJRH0pOwoKLy9hZGQgeHAgYm90IGhlcmUKY29uc3QgeHBWZXJzaW9uQm90ID0ge307Cgp4cFZlcnNpb25Cb3Quc3BhY2UgPSAic2hhcmVkIjsKeHBWZXJzaW9uQm90LmlkID0gImFiWFBCb3QiOwp4cFZlcnNpb25Cb3QudGFncyA9IHt9Owp4cFZlcnNpb25Cb3QudGFncy5mb3JtID0gIm5vdGhpbmciOwp4cFZlcnNpb25Cb3QudGFncy5zeXN0ZW0gPSAiYWIucGF0dGVybi5hYlhQQm90IjsKeHBWZXJzaW9uQm90LnRhZ3MuYXV0aG9ySUQgPSBhdXRoQm90LmlkOwp4cFZlcnNpb25Cb3QudGFncy52ZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uOwp4cFZlcnNpb25Cb3QudGFncy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKeHBWZXJzaW9uQm90LnRhZ3Muc2lnbmF0dXJlID0gZWdnQ2hlY2suc2lnbmF0dXJlOwp4cFZlcnNpb25Cb3QudGFncy5hYklnbm9yZSA9IHRydWU7CgpzdGF0ZS5hYlhQQm90ID0geHBWZXJzaW9uQm90OwoKLy9hZGRpdGlvbmFsIGZpbGUgZGF0YQpmb3JtYXR0ZWRGaWxlLnZlcnNpb24gPSAxOwpmb3JtYXR0ZWRGaWxlLnNpZ25hdHVyZSA9IGVnZ0NoZWNrLnNpZ25hdHVyZTsKZm9ybWF0dGVkRmlsZS5zdGF0ZSA9IHN0YXRlOwoKLy9hY3R1YWwgZW5jcnlwdGlvbiBpZiBjaG9zZW4KaWYgKGtleSkgCnsKICAgIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShmb3JtYXR0ZWRGaWxlKTsKCiAgICBmb3JtYXR0ZWRGaWxlID0gY3J5cHRvLmVuY3J5cHQoa2V5LCBmb3JtYXR0ZWRGaWxlKTsKfQoKLy9wdWJsaXNoIHRoZSBmaWxlCmxldCBwdWJsaXNoRmlsZSA9IGF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoRmlsZSh7ZmlsZTogZm9ybWF0dGVkRmlsZSwgZmlsZU5hbWU6IGFiSUR9KTsKCi8vZ2F0aGVyIGFkZGlvbmFsIGVnZyBkYXRhCmVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkucHVzaChwdWJsaXNoRmlsZS51cmwpOwplZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKZWdnQ2hlY2suZWdnRGF0YS50YXJnZXRWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CgovL3B1Ymxpc2ggZWdnL2FiIHJlY29yZApsZXQgcHVibGlzaFJlY29yZCA9IGF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoUmVjb3JkKHtkYXRhOiBlZ2dDaGVjay5lZ2dEYXRhLCByZWNvcmROYW1lOiBhYklELCBwdWJsaWNGYWNpbmc6IHB1YmxpY0ZhY2luZ30pOwpsZXQgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CgovL3B1Ymxpc2hpbmcgc2hvdXQKc3VwZXJTaG91dCgib25BQlB1Ymxpc2hlZCIsIHtzdWNjZXNzOiBwdWJsaXNoRmlsZS5zdWNjZXNzLCBhYjogYWJJRCwgZmlsZUFkZHJlc3M6IHB1Ymxpc2hGaWxlLnVybH0pOwoKY29uc3Qgc3R1ZGlvTGluayA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgovL3NlbmQgZGF0YSBhbmQgZm9ybWF0IHVybCBpZiBkYXRhIHN1Y2Nlc3NmdWxseSBzZW50CmlmIChwdWJsaXNoUmVjb3JkLnN1Y2Nlc3MpCnsKICAgIGNvbnN0IGJpb3MgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSUyMGluc3QiIDogImxvY2FsJTIwaW5zdCI7CiAgICBjb25zdCBpbnN0VHlwZSA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCIKCiAgICBzZXRUYWdNYXNrKGxpbmtzLmxlYXJuLCAiYWJYUCIsICIwIiwgImxvY2FsIik7CgogICAgaWYgKGtleSAmJiBjb25maWdCb3QudGFncy5tYW51YWxQdWJsaXNoKSAKICAgIHsKICAgICAgICBvcy5zZXRDbGlwYm9hcmQoc2l0ZU9yaWdpbiArICIvP3BhdHRlcm49IiArIGFiSUQgKyAiJmtleT0iICsga2V5ICsgIiZzdHVkaW89IiArIHN0dWRpb0xpbmsgKyAiJmJpb3M9IiArIGJpb3MpOwogICAgICAgIAogICAgICAgIG9zLnRvYXN0KGBlbmNyeXB0ZWQgZGF0YSB3aXRoIGEgJHtpbnN0VHlwZX0gaW5zdCB1cmwgY29waWVkIHRvIGNsaXBib2FyZGApOwogICAgfQogICAgZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCkKICAgIHsKICAgICAgICBvcy5zZXRDbGlwYm9hcmQoc2l0ZU9yaWdpbiArICIvP3BhdHRlcm49IiArIGFiSUQgKyAiJnN0dWRpbz0iICsgc3R1ZGlvTGluayArICImYmlvcz0iICsgYmlvcyk7CgogICAgICAgIG9zLnRvYXN0KGAke2luc3RUeXBlfSBpbnN0IHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkYCk7CiAgICB9CgogICAgdHJ5IAogICAgewogICAgICAgIGF3YWl0IGFuYWx5dGljcy5yZWNvcmRFdmVudCgnYWJfZWdnX3B1Ymxpc2gnLCB7IGFiOiBhYklELCB2ZXJzaW9uOiBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCB9KTsKICAgIH0KICAgIGNhdGNoIChlKSAKICAgIHsKICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgIH0KfQplbHNlCnsKICAgIGlmICghY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlKQogICAgewogICAgICAgIG9zLnRvYXN0KCJwdWJsaXNoaW5nIGZhaWxlZCwgcGxlYXNlIHRyeSBhZ2FpbiIpOwogICAgfQoKICAgIGFiLmxvZyhhYlJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBwdWJsaXNoaW5nIGZhaWxlZCIpOwogICAgCiAgICBjb25zb2xlLmxvZyhwdWJsaXNoUmVjb3JkKTsKfQoKLy9jbGVhciBwcm9ncmVzcyBiYXIKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCA9IG51bGw7CgpyZXR1cm4gcHVibGlzaFJlY29yZDsnAI6JhYgEhFgIYWJJZ25vcmUCBACOiYWIBKzsAQR0cnVlJwCOiYWIBIRYCmFiRG93bmxvYWQCBACOiYWIBLHsAd4EQC8vZG93bmxvYWQgYm90cyAoZWl0aGVyIHNlbGVjdGVkIG9yIGFsbCBleHBlcmllbmNlKQpsZXQgZG93bmxvYWRCb3RzOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCnsKICAgIGRvd25sb2FkQm90cyA9IFtsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzXTsKCiAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZG93bmxvYWRpbmcgYm90Iik7Cn0KZWxzZQp7CiAgICBkb3dubG9hZEJvdHMgPSBnZXRCb3RzKGJ5TW9kKHsiYWJJZ25vcmUiOiBudWxsLCAic3BhY2UiOiAic2hhcmVkIn0pKTsKCiAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZG93bmxvYWRpbmcgaW5zdCIpOwp9CgppZiAoIUFycmF5LmlzQXJyYXkoZG93bmxvYWRCb3RzKSkKewogICAgZG93bmxvYWRCb3RzID0gW2Rvd25sb2FkQm90c107Cn0KCmxldCBjdXJyZW50SW5zdCA9IG9zLmdldEN1cnJlbnRJbnN0KCk7Cgpvcy5kb3dubG9hZEJvdHMoZG93bmxvYWRCb3RzLCBjdXJyZW50SW5zdCk7CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7JwCOiYWIBIRYDW1hbmlmZXN0YXRpb24CBACOiYWIBJDxASjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCOiYWIBIRYBG1lbnUCBACOiYWIBLfxASjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCOiYWIBIRYEmFiUHJldmlvdXNFZ2dDaGVjawIEAI6JhYgE3vEB2Q9ALy90aGlzIGZ1bmN0aW9uIGNoZWNrcyBmb3IgcHJldmlvdXMgZWdncyBhdCBhIHNwZWNpZmllZCBhYiwgcmV0dXJuaW5nIGFueSBkYXRhIHRoYXQgaXQgZmluZHMKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKCmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgZWdnSGlzdG9yeTsKbGV0IGVnZ0lEOwpsZXQgdGFyZ2V0VmVyc2lvbk51bTsKbGV0IGxhc3RIYXNoOwpsZXQgbWF4VmVyc2lvbk51bTsKbGV0IHN0YWJsZVZlcnNpb247CmxldCBmZWVkYmFja1ZlcnNpb247CmxldCBwcmV2aW91c1hQOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpsZXQgcmVjb3JkTG9va3VwID0gYXdhaXQgb3MuZ2V0RGF0YSh1c2VyUmVjb3JkLCBhYklEKS5jYXRjaChlID0+IHt9KTsKCmlmIChyZWNvcmRMb29rdXAuc3VjY2VzcykgCnsKICAgIGVnZ0hpc3RvcnkgPSByZWNvcmRMb29rdXAuZGF0YS5lZ2dWZXJzaW9uSGlzdG9yeTsKICAgIGVnZ0lEID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnSUQ7CiAgICBwcmV2aW91c1hQID0gcmVjb3JkTG9va3VwLmRhdGEueHAgPz8gMDsKICAgIHRhcmdldFZlcnNpb25OdW0gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7CiAgICBsYXN0SGFzaCA9IGVnZ0hpc3RvcnlbdGFyZ2V0VmVyc2lvbk51bSAtIDFdOwogICAgc3RhYmxlVmVyc2lvbiA9IHJlY29yZExvb2t1cC5kYXRhLnN0YWJsZVZlcnNpb247CiAgICBmZWVkYmFja1ZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5mZWVkYmFja1ZlcnNpb247CiAgICBtYXhWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9IAplbHNlIAp7CiAgICBlZ2dIaXN0b3J5ID0gW107CiAgICBlZ2dJRCA9IHV1aWQoKTsKICAgIHRhcmdldFZlcnNpb25OdW0gPSAxOwogICAgbGFzdEhhc2ggPSAibm9uZSI7CiAgICBtYXhWZXJzaW9uTnVtID0gMTsKICAgIHByZXZpb3VzWFAgPSAwOwp9CgppZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gImZlZWRiYWNrIikgCnsKICAgIGZlZWRiYWNrVmVyc2lvbiA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfQplbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9PSAic3RhYmxlIikKewogICAgc3RhYmxlVmVyc2lvbiA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfQoKY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwoKbGV0IGVnZyA9IHt9OwoKZWdnLmVnZ1ZlcnNpb25IaXN0b3J5ID0gZWdnSGlzdG9yeTsKZWdnLmVnZ0Zvcm1hdFZlcnNpb24gPSBlZ2dJRDsKZWdnLnRhcmdldFZlcnNpb24gPSB0YXJnZXRWZXJzaW9uTnVtOwplZ2cubWF4VmVyc2lvbiA9IG1heFZlcnNpb25OdW07CmVnZy5sYWJlbCA9ICJ2Iit0YXJnZXRWZXJzaW9uTnVtOwplZ2cuc3RhYmxlVmVyc2lvbiA9IHN0YWJsZVZlcnNpb247CmVnZy5mZWVkYmFja1ZlcnNpb24gPSBmZWVkYmFja1ZlcnNpb247CmVnZy5hYklEID0gYWJJRDsKZWdnLnhwID0gbGlua3MubGVhcm4udGFncy5hYlhQOwoKbGV0IHNpZ25hdHVyZSA9IHt9OwpsZXQgZGF0ZSA9IG5ldyBEYXRlKCk7CmxldCB0aW1lID0gZGF0ZS5nZXRUaW1lKCk7CgpzaWduYXR1cmUucHJldmlvdXNIYXNoID0gbGFzdEhhc2g7CnNpZ25hdHVyZS5hYlZlcnNpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29yZVZlcnNpb24rIi4iK2xpbmtzLnJlbWVtYmVyLnRhZ3MuYWJDb3JlSXRlcmF0aW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OygAjomFiASEWAxhYkJvdFZlcnNpb24BfYQDJwCOiYWIBIRYD2FiQm90TWVudUFjdGlvbgIEAI6JhYgEuYECTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwCOiYWIBIRYDmFiQm90TWVudUxhYmVsAgQAjomFiASHggIFc2hhcmUnAI6JhYgEhFgNYWJCb3RNZW51SWNvbgIEAI6JhYgEjYICCWlvc19zaGFyZScAjomFiASEWBJhYkJvdE1lbnVTb3J0T3JkZXICBACOiYWIBJeCAgEzJwCOiYWIBIRYBWxlYXJuAgQAjomFiASZggIo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAjomFiASEWA1hYlB1Ymxpc2hVVUFCAgQAjomFiATAggKnD0Bjb25maWdCb3QudGFncy51dWFiU2NhbiA9IG51bGw7CgpsZXQgdXVhYkNvbmZpZyA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7YWJJRDogY29uZmlnQm90LnRhZ3MudXVhYiwgcmV0dXJuVHlwZTogImRhdGEifSk7CgpsZXQgcGluID0gYXdhaXQgb3Muc2hvd0lucHV0KG51bGwsewogICAgdGl0bGU6ICJlbnRlciBwaW4iLAogICAgdHlwZTogInNlY3JldCIKfSk7CgppZiAocGluKQp7CiAgICBsZXQgcGggPSBjcnlwdG8uc2hhMjU2KHBpbikuc3Vic3RyaW5nKDAsNCk7CgogICAgaWYgKHBoID09IGNvbmZpZ0JvdC50YWdzLnBoKQogICAgewogICAgICAgIGxldCByZWNvcmRLZXk7CiAgICAgICAgbGV0IGVnZ0RhdGFDaGVjazsKICAgICAgICBsZXQgZWdnRGF0YTsKCiAgICAgICAgZm9yICh0YWcgaW4gdXVhYkNvbmZpZy5zdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0YWcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlY29yZEtleSA9IHV1YWJDb25maWcuc3RhdGVbdGFnXS50YWdzLnJlY29yZEtleTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoYXQpCiAgICAgICAgewogICAgICAgICAgICBlZ2dEYXRhQ2hlY2sgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgdGhhdC50YXJnZXRSZWNvcmQpOwoKICAgICAgICAgICAgaWYgKGVnZ0RhdGFDaGVjay5zdWNjZXNzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZWdnRGF0YUNoZWNrLmRhdGEuZWdncykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0cnkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVnZ0RhdGEgPSBKU09OLnBhcnNlKGVnZ0RhdGFDaGVjay5kYXRhLmVnZ3MpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVnZ0RhdGEubGVuZ3RoID49IDEyKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy50b2FzdCgicHJhY3RpY2UgcGVybWl0IGZ1bGwiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG91dCgiYWJSZWZyZXNoIik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhdGNoCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiZWdnIGRhdGEgbm90IHJlYWRhYmxlIik7CgogICAgICAgICAgICAgICAgICAgICAgICBlZ2dEYXRhID0gW107CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYWJSZWNvcmRLZXkgPSByZWNvcmRLZXk7CgogICAgICAgIGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2ggPSB0cnVlOwoKICAgICAgICB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogY29uZmlnQm90LnRhZ3MuYWIsIGtleTogY29uZmlnQm90LnRhZ3Mua2V5fSk7CgogICAgICAgIGVnZ0RhdGEucHVzaChjb25maWdCb3QudGFncy5hYik7CgogICAgICAgIGVnZ0RhdGFUb1B1Ymxpc2ggPSB7ZWdnczogSlNPTi5zdHJpbmdpZnkoZWdnRGF0YSl9OwoKICAgICAgICBhd2FpdCBvcy5yZWNvcmREYXRhKHJlY29yZEtleSwgdGhhdC50YXJnZXRSZWNvcmQsIGVnZ0RhdGFUb1B1Ymxpc2gpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGF3YWl0IG9zLnRvYXN0KCJwaW4gZG9lcyBub3QgbWF0Y2giLCAyKTsKCiAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwogICAgfQp9CmVsc2UKewogICAgYXdhaXQgb3MudG9hc3QoIm5vIHBpbiBnaXZlbiIsIDIpOwoKICAgIHNob3V0KCJhYlJlZnJlc2giKTsKCiAgICByZXR1cm4KfScAjomFiASEWAthYlFSUHVibGlzaAIEAI6JhYgE6JEC7wRAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSB7CiAgICBzaG91dCgiYWJQdWJsaXNoQUIiLCB7YWI6IHRoYXR9KTsKCiAgICB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogdGhhdH0pOwoKICAgIHJldHVybjsKfQoKaWYgKHNjYW5uZWRVUkwuc2VhcmNoUGFyYW1zLmdldCgicGgiKSkgCnsKICAgIGxldCB0YXJnZXRSZWNvcmQgPSBzY2FubmVkVVJMLnNlYXJjaFBhcmFtcy5nZXQoImluc3QiKTsKCiAgICBjb25maWdCb3QudGFncy51dWFiID0gc2Nhbm5lZFVSTC5zZWFyY2hQYXJhbXMuZ2V0KCJhYiIpOwogICAgY29uZmlnQm90LnRhZ3MucGggPSBzY2FubmVkVVJMLnNlYXJjaFBhcmFtcy5nZXQoInBoIik7CiAgICBjb25maWdCb3QudGFncy5hYiA9IHV1aWQoKTsKICAgIGNvbmZpZ0JvdC50YWdzLmtleSA9IHNjYW5uZWRVUkwuc2VhcmNoUGFyYW1zLmdldCgicGgiKTsKCiAgICB0aGlzQm90LmFiUHVibGlzaFVVQUIoe3RhcmdldFJlY29yZDogdGFyZ2V0UmVjb3JkfSk7Cn0KZWxzZSAKewogICAgb3MudG9hc3QoInVuc3VwcG9ydGVkIHVybCBmb3JtYXQiKTsKfScAjomFiASEWAZzZWFyY2gCBACOiYWIBNiWAijwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwCOiYWIBIRYB2FiU2hlbGwCBACOiYWIBP+WAgR0cnVlJwCOiYWIBIRYDHN0dWRpb1NlbGVjdAIEAI6JhYgEhJcC0QtALy9zaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJTdHVkaW9NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3Qgc3R1ZGlvcyA9IHRoYXQuc3R1ZGlvczsKY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJTdHVkaW9NZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSAwOwptZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24uYWJTdHVkaW9NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5sYWJlbCA9ICJwbGF5ZXIgc3R1ZGlvIjsKbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IHRhcmdldFN0dWRpbyA9PSBhdXRoQm90LmlkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24uc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQCBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHRhZ3Muc3R1ZGlvSUQ7CgpsaW5rcy5tYW5hZ2VyLmxpbmtzLnN0dWRpb1NlbGVjdEJ1dHRvbi50YWdzLmxhYmVsID0gdGFncy5sYWJlbDsKCnNob3V0KCJhYlN0dWRpb01lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKCmZvciAobGV0IGkgPSAwOyBpIDwgc3R1ZGlvcy5sZW5ndGg7IGkrKykKewogICAgbGV0IGFjdGl2ZVN0dWRpbyA9IHN0dWRpb3NbaV07CiAgICBjb25zb2xlLmxvZygiQUNUSVZFIiwgdGFyZ2V0U3R1ZGlvICsgIiwgIiArIGFjdGl2ZVN0dWRpby5zdHVkaW9JZCkKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwCOiYWIBIRYDmFiUHVibGlzaEFza0lEAgQAjomFiATUogL0BEBsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5pbnB1dC5hYlByb2dyZXNzQmFyKGBwdWJsaXNoaW5nICR7dGhhdC5hc2tJRH1gKTsKCmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7Cgpjb25zdCBwYXR0ZXJuSUQgPSB0aGF0LnBhdHRlcm5JRDsKY29uc3Qgc3R1ZGlvSUQgPSB0aGF0LnN0dWRpb0lEID8gdGhhdC5zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBhdXRoQm90LmlkOwpjb25zdCBhc2tJRCA9ICJhc2tfIiArIHRoYXQuYXNrSUQucmVwbGFjZUFsbCgiLSIsICIiKTsKY29uc3QgZW5kcG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmNvbnN0IHB1Ymxpc2hBc2sgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFza0lELCB7cGF0dGVybklEOiBwYXR0ZXJuSUQsIHN0dWRpb0lEOiBzdHVkaW9JRH0sIHtlbmRwb2ludDogZW5kcG9pbnQsIHVwZGF0ZVBvbGljeTogW2F1dGhCb3QuaWRdfSk7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gcHVibGlzaEFzazsnAI6JhYgEhFgFaW5wdXQCBACOiYWIBMmnAijwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwCOiYWIBIRYC2FiRW1iZWRMaW5rAgQAjomFiATwpwKkA0Bjb25zdCBhYiA9IHRoYXQgPyB0cnVlIDogZmFsc2U7CmNvbnN0IGVtYmVkTGluayA9IGFiID8gImFiPSIgKyB0aGF0IDogImluc3Q9IiArIGNvbmZpZ0JvdC50YWdzLmluc3Q7CmNvbnN0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwpjb25zdCBlbWJlZFRleHQgPSBgPCFET0NUWVBFIGh0bWw+CsKgwqDCoMKgPGh0bWw+CsKgwqDCoMKgwqDCoMKgwqA8aGVhZD48L2hlYWQ+CsKgwqDCoMKgwqDCoMKgwqA8Ym9keT4KwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgPGlmcmFtZSBzcmM9IiR7c2l0ZU9yaWdpbiArICIvPyIgKyBlbWJlZExpbmt9IiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSI0MDAiIC8+CsKgwqDCoMKgwqDCoMKgwqA8L2JvZHk+CsKgwqDCoMKgPC9odG1sPmA7CgpyZXR1cm4gZW1iZWRUZXh0OycAjomFiASEWA9hYlBhdHRlcm5VcGRhdGUCBACOiYWIBOmqAucEQC8vc2hvdXQoImFiUGF0dGVyblVwZGF0ZSIsIHthYklEOiBhYklELCBzdHVkaW86c3R1ZGlvPywgYm90czogYm90cz99KTsKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmlmICghYXV0aEJvdCkKewogICAgcmV0dXJuOwp9Cgpjb25zdCBhYklEID0gdGhhdC5hYklEOwpjb25zdCBzdHVkaW8gPSB0aGF0LnN0dWRpbyA/IHRoYXQuc3R1ZGlvIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKY29uc3QgYWJNYW5pZmVzdCA9IGdldEJvdChieU1vZCh7YWJFZ2c6IHRydWUsIG9yaWdpbl9hYjogYWJJRH0pKTsKCmlmICghYWJNYW5pZmVzdCkKewogICAgc2hvdXQoIm9uTG9va3VwQUJFZ2dzIiwge2FiSUQ6IGFiSUQsIHJlY29yZEtleTogc3R1ZGlvLCBhdXRvSGF0Y2g6IHRydWV9KTsKCiAgICByZXR1cm47Cn0KCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gc3R1ZGlvOwoKY29uc3QgYWJCb3RzID0gdGhhdC5ib3RzID8/IGdldEJvdHMoImFiSURPcmlnaW4iLCBhYklEKTsKCmF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiBhYklELCB0YXJnZXQ6IGFiQm90cywgcHVibGljRmFjaW5nOiB0cnVlfSk7JwEEYm90cyRkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUBJwCOiYWIBNGvAgZzeXN0ZW0CBACOiYWIBNKvAg9hYi5zaGVsbC5zZWFyY2gnAI6JhYgE0a8CBGZvcm0CBACOiYWIBOKvAgdub3RoaW5nJwCOiYWIBNGvAg5hYlJldHJpZXZlRmlsZQIEAI6JhYgE6q8CggFALy9wdWxsIGRvd24gZmlsZSBkYXRhCmlmICghdGhhdC51cmwpCnsKICAgIHJldHVybiAibm8gZmlsZSB1cmwgc3VwcGxpZWQiOwp9CgpsZXQgZGF0YSA9IGF3YWl0IG9zLmdldEZpbGUodGhhdC51cmwpOwoKcmV0dXJuIGRhdGE7JwCOiYWIBNGvAhBhYlJldHJpZXZlUmVjb3JkAgQAjomFiATtsALsBEAvL3JldHJpZXZlIHNwZWNpZmllZCByZWNvcmQKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CgpsZXQgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCmlmICh0aGF0LnJlY29yZEtleSkKewogICAgcmVjb3JkS2V5ID0gdGhhdC5yZWNvcmRLZXk7Cn0KZWxzZSBpZiAoYXV0aEJvdCkKewogICAgaWYgKGF1dGhCb3QuaWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQogICAgewogICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgfQp9CgpsZXQgcmVjb3JkRW5kcG9pbnQgPSB0aGF0LnJlY29yZEVuZHBvaW50ID8gdGhhdC5yZWNvcmRFbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKCmlmICghcmVjb3JkTmFtZSkKewogICAgcmV0dXJuICJubyByZWNvcmQgbmFtZSBzdXBwbGllZCI7Cn0KCmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgcmVjb3JkTmFtZSwgcmVjb3JkRW5kcG9pbnQpOwoKLy9BREQgYWRkaXRpb25hbCBlcnJvciBoYW5kbGluZz8KCnJldHVybiBnZXRSZWNvcmQ7JwCOiYWIBNGvAghyZW1lbWJlcgIEAI6JhYgE2rUCKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAI6JhYgE0a8CDW1hbmlmZXN0YXRpb24CBACOiYWIBIG2Aijwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCOiYWIBNGvAg5vbkxvb2t1cEFCRWdncwIEAI6JhYgEqLYCmCJALy9zaG91dCgib25Mb29rdXBBQkVnZ3MiLCB7YWJJRDogYWJJRCwga2V5OiBrZXksIGF1dG9IYXRjaDogYm9vbGVhbiwgcmV0dXJuVHlwZTogZGF0YS9udWxsfSk7CmFiLmxvZyhhYlJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBsb2FkaW5nICIgKyB0aGF0LmFiSUQpOwoKLy9jbGVhciBhYi0xCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKQp7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfQoKbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MuaW5wdXQuYWJQcm9ncmVzc0JhcihgbG9hZGluZyAke3RoYXQuYWJJRH1gKTsKCi8vY29uc3RhbnRzIGluIHJlZ2FyZHMgdG8gdGhlIGFiIHRvIGJlIGxvb2tlZCB1cApjb25zdCBhYklEID0gdGhhdC5hYklEOwpjb25zdCBpbml0aWFsQm9vdCA9IHRoYXQuaW5pdGlhbEJvb3Q7CmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQuYXV0b0hhdGNoOwoKLy9yZWNvcmRLZXkgaXMgdmFyaWFibGUgZGVwZW5kaW5nIG9uIGlmIHB1YmxpYwpsZXQgcmVjb3JkS2V5ID0gdGhhdC5yZWNvcmRLZXkgPz8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvOwpsZXQgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKLy92YXJpYWJsZXMgZm9yIGVnZy9hYiBoYXRjaGluZwpsZXQgcmV0dXJuVHlwZSA9IHRoYXQucmV0dXJuVHlwZTsKbGV0IGtleSA9IHRoYXQua2V5OwpsZXQgbmV3RWdnOwoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgdGhlIHJldHJpZXZlZCBkYXRhLCBzZWFyY2hlcyBhZ2FpbiBpZiBub25lIGNhbWUgdGhyb3VnaAppZiAoIWdldFJlY29yZC5zdWNjZXNzICYmIHBvc3NpYmxlQXV0aC5pZCA9PSByZWNvcmRLZXkgJiYgbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSAmJiBnZXRSZWNvcmQuZXJyb3JDb2RlICE9ICJub3RfYXV0aG9yaXplZCIpCnsKICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYWJJRCk7Cn0KZWxzZSBpZiAoIWdldFJlY29yZC5zdWNjZXNzKQp7CiAgICBpZiAoIXJlY29yZEtleSkKICAgIHsKICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKICAgICAgICByZWNvcmRLZXkgPSBhdXRoQm90LmlkOwogICAgfQoKICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwoKICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKfQoKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykKewogICAgb3MudG9hc3QoYG5vIGRhdGEgZm91bmQgaW4gJHthYklEfWApOwoKICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgaWYgKHByb2dyZXNzQnV0dG9uKQogICAgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQoKICAgIHJldHVybiB7c3VjY2VzczogZmFsc2V9Owp9CmVsc2UKewogICAgLy9wYWNrYWdlIHRoZSByZWNvcmQgZGF0YQogICAgbmV3RWdnID0gZ2V0UmVjb3JkLmRhdGE7Cn0KCmFiLmxvZyhhYlJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgdGhhdC5hYklEICsgIiBsb2FkZWQsIHZlcnNpb24gIiArIGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBnZXRSZWNvcmQuZGF0YS5tYXhWZXJzaW9uKTsKCi8vdGhpcyBsb2dpYyBwYXJzZXMgdGhlIGRhdGEgZGVwZW5kYW50IG9uIGhvdyBpdCB3YXMgYWNjZXNzZWQvZ2FpbmVkCmlmIChyZXR1cm5UeXBlID09ICJkYXRhIiAmJiBnZXRSZWNvcmQuc3VjY2VzcykKewogICAgbGV0IHZlcnNpb24gPSBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uIC0gMTsKCiAgICBpZiAodGhhdC5hYlZlcnNpb24pCiAgICB7CiAgICAgICAgaWYgKCFpc05hTih0aGF0LmFiVmVyc2lvbikpCiAgICAgICAgewogICAgICAgICAgICB2ZXJzaW9uID0gdGhhdC5hYlZlcnNpb24gLSAxOwogICAgICAgIH0KICAgIH0KCiAgICBsZXQgZWdnRGF0YVVSTCA9IGdldFJlY29yZC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5W3ZlcnNpb25dOwogICAgbGV0IHJldHVybkRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGVnZ0RhdGFVUkwpOwoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikKICAgIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KCiAgICByZXR1cm4gcmV0dXJuRGF0YTsKfQplbHNlIGlmIChyZXR1cm5UeXBlID09ICJkYXRhIikKewogICAgbGV0IHZlcnNpb25BcnJheSA9IEpTT04ucGFyc2UobmV3RWdnLmVnZ1ZlcnNpb25IaXN0b3J5KTsKICAgIGxldCBmaWxlVVVJRCA9IHZlcnNpb25BcnJheVtuZXdFZ2cubWF4VmVyc2lvbiAtIDFdOwogICAgbGV0IGZpbGVuYW1laGFzaExUTSA9IGNyeXB0by5zaGEyNTYoZmlsZVVVSUQpOwogICAgbGV0IGZpbGV1cmxoYXNoTFRNID0gImF1eF8iICsgZmlsZW5hbWVoYXNoTFRNICsgJy5hdXgnOwogICAgbGV0IHRhcmdldExUTVVSTCA9ICJodHRwczovL2J1aWxkZXItbHRtLWZpbGVzLnMzLmFtYXpvbmF3cy5jb20vIiArIGZpbGV1cmxoYXNoTFRNOwogICAgbGV0IG8gPSB7fTsKICAgIG8ubWV0aG9kID0gIkdFVCI7CiAgICBvLnVybCA9IHRhcmdldExUTVVSTDsKCiAgICBmaWxlR2V0ID0gYXdhaXQgd2ViaG9vayhvKTsKCiAgICBpZiAocHJvZ3Jlc3NCdXR0b24pCiAgICB7CiAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICB9CgogICAgaWYgKGZpbGVHZXQuc3RhdHVzICE9IDIwMCkKICAgIHsKICAgICAgICBvcy50b2FzdCgibm8gZmlsZSBmb3VuZCIpOwoKICAgICAgICBzaG91dCgiYWJSZWZyZXNoIik7CgogICAgICAgIHJldHVybiB7c3VjY2VzczogZmFsc2V9OwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGZpbGVHZXQgPSBmaWxlR2V0LmRhdGE7CiAgICB9CgogICAgcmV0dXJuIGZpbGVHZXQ7Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikKewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpCiAgICB7CiAgICAgICAgY29uc3QgYWJCb3QgPSBsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90OwoKICAgICAgICBjdXJyZW50RGltID0gYWJCb3QudGFncy5kaW1lbnNpb247CiAgICB9Cn0KZWxzZQp7CiAgICBjdXJyZW50RGltID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9CgovL2NoZWNrcyBmb3IgZ3JpZCBmb2N1cwppZiAoIWxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJHcmlkRm9jdXMpIAp7CiAgICBkaW1lbnNpb25YID0gbnVsbDsKICAgIGRpbWVuc2lvblkgPSBudWxsOwp9CmVsc2UKewogICAgbGV0IGhhdGNoUG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKICAgIGN1cnJlbnREaW0gPSBoYXRjaFBvaW50LmRpbWVuc2lvbjsKICAgIGRpbWVuc2lvblggPSBoYXRjaFBvaW50LnBvc2l0aW9uLng7CiAgICBkaW1lbnNpb25ZID0gaGF0Y2hQb2ludC5wb3NpdGlvbi55OwogICAgc3BhY2VNb2QgPSB7c3BhY2U6ICJzaGFyZWQifTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKQp7CiAgICBkaW1Nb2QgPSB7W2N1cnJlbnREaW1dOiB0cnVlLCBbY3VycmVudERpbSsiWCJdOiBkaW1lbnNpb25YLCBbY3VycmVudERpbSsiWSJdOiBkaW1lbnNpb25ZLCBkaW1lbnNpb246IGN1cnJlbnREaW19Owp9CmVsc2UKewogICAgaWYgKGNvbmZpZ0JvdC50YWdzLmtleSAmJiAhdGhhdC5rZXkpCiAgICB7CiAgICAgICAga2V5ID0gY29uZmlnQm90LnRhZ3Mua2V5CiAgICB9CgogICAgZGltTW9kID0ge2F1dG9IYXRjaDogdHJ1ZSwga2V5OiBrZXl9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmF3YWl0IHRoaXNCb3QubWFuaWZlc3RPdm8oe2FiSUQ6IGFiSUQsIHN0dWRpbzogcmVjb3JkS2V5LCBkaW1Nb2Q6IGRpbU1vZCwgc3BhY2VNb2Q6IHNwYWNlTW9kLCBlZ2dEYXRhOiBuZXdFZ2csIGluaXRpYWxCb290OiBpbml0aWFsQm9vdCwgZWdnUGFyYW1ldGVyczogdGhhdC5lZ2dQYXJhbWV0ZXJzfSk7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4ge3N1Y2Nlc3M6IHRydWV9OycAjomFiATRrwILbWFuaWZlc3RPdm8CBACOiYWIBMHYApgMQC8vZWdnIHZpc3VhbGl6YXRpb24Kc2hvdXQoImFiTWVudVJlc2V0Iik7CgppZiAobGlua3MubWFuaWZlc3RhdGlvbikKewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpCiAgICB7CiAgICAgICAgZGVzdHJveShsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KTsKICAgIH0KfQoKaWYgKGxpbmtzLm92b0JvdCkKewogICAgZGVzdHJveShsaW5rcy5vdm9Cb3QpOwp9CgpsZXQgc3BhY2VNb2QgPSB0aGF0LnNwYWNlTW9kOwpsZXQgZGltTW9kID0gdGhhdC5kaW1Nb2Q7CmxldCBlZ2dEYXRhID0gdGhhdC5lZ2dEYXRhOwpsZXQgZWdnUGFyYW1ldGVycyA9IHRoYXQuZWdnUGFyYW1ldGVyczsKbGV0IGVnZ01vZCA9IHt9OwoKZWdnTW9kLnNwYWNlID0gInRlbXBMb2NhbCI7CmVnZ01vZC5pbml0aWFsVGltZXIgPSB0cnVlOwplZ2dNb2QuYWJJRCA9IHRoYXQuYWJJRDsKZWdnTW9kLnN0dWRpbyA9IHRoYXQuc3R1ZGlvOwplZ2dNb2QuaW5pdGlhbEJvb3QgPSB0aGF0LmluaXRpYWxCb290OwplZ2dNb2QuZWdnUGFyYW1ldGVycyA9IGVnZ1BhcmFtZXRlcnM7CmVnZ01vZC5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKZWdnTW9kLm9uQ2xpY2sgPSBgQCBsaW5rcy5tYW5hZ2VyLmludGVyYWN0T3ZvKCk7YDsKZWdnTW9kLm9uQ3JlYXRlID0gYGA7CmVnZ01vZC5mb3JtID0gImVnZyI7CmVnZ01vZC5wcm9ncmVzc0JhckNvbG9yID0gIiNCRjVFNjYiOwplZ2dNb2QucHJvZ3Jlc3NCYXJCYWNrZ3JvdW5kQ29sb3IgPSAiIzU5Mjk4OSI7CmVnZ01vZC5sYWJlbFNpemUgPSAwLjU7CmVnZ01vZC5sYWJlbENvbG9yID0gIiM0MDQwNDAiOwplZ2dNb2Qub25Qb2ludGVyRW50ZXIgPSAiQCBvcy50b2FzdCh0YWdzLmFiSUQgKyAnIHYnK3RhZ3MudGFyZ2V0VmVyc2lvbik7IjsKZWdnTW9kLmxhYmVsUG9zaXRpb24gPSAiZnJvbnQiOwplZ2dNb2Qub3JpZW50YXRpb25Nb2RlID0gImJpbGxib2FyZEZyb250IjsKZWdnTW9kLm9uRGVzdHJveSA9IGBAIGxpbmtzLm1hbmFnZXIubWFza3Mub3ZvQm90ID0gbnVsbDtgOwplZ2dNb2QuZWdnVGltZXIgPSBgQCBpZiAodGFncy5wcm9ncmVzc0JhciA8IDEpIAp7CiAgICB0YWdzLnByb2dyZXNzQmFyICs9IDAuMTsKCiAgICBzZXRUaW1lb3V0KCgpID0+IHt3aGlzcGVyKHRoaXNCb3QsICJlZ2dUaW1lciIpO30sIDc1KTsKfQplbHNlCnsKICAgIHRoaXNCb3Qub25DbGljaygpOwogICAgCiAgICB0YWdzLnByb2dyZXNzQmFyID0gbnVsbDsKfWA7CgpsZXQgb3ZvID0gYXdhaXQgY3JlYXRlKGVnZ0RhdGEsIGVnZ01vZCwgZGltTW9kLCBzcGFjZU1vZCk7CgppZiAob3ZvLnRhZ3MuYXV0b0hhdGNoKQp7CiAgICBhd2FpdCB0aGlzQm90LmhhdGNoT3ZvKG92byk7Cn0KZWxzZQp7CiAgICBvdm8udGFncy5wcm9ncmVzc0JhciA9IDA7IAogICAgCiAgICBjb25maWdCb3QudGFncy52ZXJzaW9uID0gb3ZvLnRhZ3MubWF4VmVyc2lvbjsKCiAgICBzZXRUaW1lb3V0KCgpID0+IHt3aGlzcGVyKG92bywgImVnZ1RpbWVyIik7fSwgNzUpOwp9CgptYXNrcy5vdm9Cb3QgPSAi8J+UlyIgKyBvdm8uaWQ7CgpyZXR1cm47JwCOiYWIBNGvAglvbktleURvd24CBACOiYWIBNbkAtoFQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gIm92byIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24ub3ZvID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9ICIjRkZGRkZGIjsKICAgIHZlcnNpb25CdXR0b24ub25LZXlVcCA9ICJAIGlmKHRoYXQua2V5cyA9PSAnU2hpZnQnKXtkZXN0cm95KHRoaXNCb3QpfTsiOwogICAgdmVyc2lvbkJ1dHRvbi5vbkNsaWNrID0gIkAgbGlua3MubWFuYWdlci5jaGFuZ2VPdm9WZXJzaW9uKCk7IjsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih2ZXJzaW9uQnV0dG9uKTsKfScAjomFiATRrwIIaGF0Y2hPdm8CBACOiYWIBK/qAo0UQC8vbG9naWMgZm9yIGhhdGNoaW5nIG9mIGFuIGFiCnNob3V0KCdvdm9NZW51UmVzZXQnKTsKCi8vZGF0YSBpbiByZWdhcmRzIHRvIHdoYXQgYWIgaXMgZ29pbmcgdG8gYmUgaGF0Y2hlZApjb25zdCBvdm8gPSB0aGF0OwoKLy9oYXRjaCBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGluaXRpYWxCb290ID0gb3ZvLnRhZ3MuaW5pdGlhbEJvb3Q7CmxldCB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiA/PyBvdm8udGFncy50YXJnZXRWZXJzaW9uOwoKaWYgKChjb25maWdCb3QudGFncy5hYlZlcnNpb24gfHwgY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb24pICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYikpCnsKICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy5hYlZlcnNpb24gPz8gY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb247Cn0KCi8vdGFyZ2V0ZWQgdmVyc2lvbnMKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gJiYgKG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MucGF0dGVybiB8fCBvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLmFiIHx8ICFpc05hTihjb25maWdCb3QudGFncy52ZXJzaW9uKSkpCnsKICAgIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJmZWVkYmFjayIpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmZlZWRiYWNrVmVyc2lvbjsKICAgIH0KICAgIGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPT0gImN1cnJlbnQiKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICB9CiAgICBlbHNlIGlmICghaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnZlcnNpb24KICAgIH0KCiAgICBjb25maWdCb3QudGFncy52ZXJzaW9uID0gbnVsbDsKfQoKaWYgKGlzTmFOKHRhcmdldFZlcnNpb24pKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwp9CgpsZXQgdmVyc2lvbkFycmF5ID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3Rvcnk7CmxldCBmaWxlVVJMID0gdmVyc2lvbkFycmF5W3RhcmdldFZlcnNpb24gLSAxXTsKbGV0IGtleSA9IG92by50YWdzLmtleSA/IG92by50YWdzLmtleSA6IGNvbmZpZ0JvdC50YWdzLmtleTsKbGV0IGZpbGVHZXQ7CgovL2FjdHVhbCBmaWxlIHJldHJpZXZhbAp0cnkKewogICAgZmlsZUdldCA9IGF3YWl0IG9zLmdldEZpbGUoZmlsZVVSTCk7Cn0KY2F0Y2ggKGVycm9yKQp7CiAgICBjb25zb2xlLmxvZyhlcnJvcik7CgogICAgb3MudG9hc3QoIm5vIGZpbGUgZm91bmQiKTsKCiAgICByZXR1cm47Cn0KCi8vaGFuZGxpbmcgZm9yIGVuY3J5cHRlZCBhYiBmaWxlCmlmIChjcnlwdG8uaXNFbmNyeXB0ZWQoZmlsZUdldCkpCnsKICAgIGlmICgha2V5KQogICAgewogICAgICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgnJywgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdFbnRlciBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgdHJ5CiAgICB7CiAgICAgICAgZmlsZUdldCA9IGNyeXB0by5kZWNyeXB0KGtleSwgZmlsZUdldCk7CiAgICB9CiAgICBjYXRjaCAoZXJyb3IpCiAgICB7CiAgICAgICAgY29uc29sZS5sb2coZXJyb3IpCgogICAgICAgIG9zLnRvYXN0KCJrZXkgZG9lcyBub3QgbWF0Y2ggZmlsZSIpOwoKICAgICAgICByZXR1cm47CiAgICB9CiAgIAogICAgZmlsZUdldCA9IEpTT04ucGFyc2UoZmlsZUdldCk7CgogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KZWxzZQp7CiAgICBmaWxlR2V0ID0gZmlsZUdldC5zdGF0ZTsKfQoKLy9jbGVhbiB1cApkZXN0cm95KG92byk7CgovL3RvYXN0IGlmIG5vdCBvbiBzdGFibGUKaWYob3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiAhPSB0YXJnZXRWZXJzaW9uKQp7CiAgICBpZiAob3ZvLnRhZ3MuZmVlZGJhY2tWZXJzaW9uID09IHRhcmdldFZlcnNpb24pCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWRpbmcgZmVlZGJhY2sgdmVyc2lvbiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWRpbmcgdmVyc2lvbiAiICsgdGFyZ2V0VmVyc2lvbiArICIgb2YgIiArIG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCArICIgb2YgIiArIG92by50YWdzLmFiSUQpOwogICAgfQp9CgovL2dlbmVyYXRlIGJvdHMgYmFzZWQgb24gdGhlIGZpbGUgcmV0cmlldmVkICpIRVJFKgphd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHtib3RzOiBmaWxlR2V0LCBvcmlnaW46IG92by50YWdzLmFiSUQsIHN0dWRpbzogb3ZvLnRhZ3Muc3R1ZGlvLCB2ZXJzaW9uOiB0YXJnZXRWZXJzaW9uLCBpbml0aWFsQm9vdDogaW5pdGlhbEJvb3QsIGVnZ1BhcmFtZXRlcnM6IG92by50YWdzLmVnZ1BhcmFtZXRlcnN9KTsKCnJldHVybjsnAI6JhYgE0a8CC2ludGVyYWN0T3ZvAgQAjomFiAS9/gKOB0AvL21hbnVhbCBoYXRjaCBtZW51CmNvbnN0IG92b0JvdCA9IHRoYXQgPyB0aGF0IDogbGlua3Mub3ZvQm90OwoKaWYgKCFvdm9Cb3QpCnsKICAgIHJldHVybjsKfQoKc2hvdXQoIm92b01lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAib3ZvIjsKCm1hc2tzLm9uR3JpZENsaWNrID0gYEAgc2hvdXQoIm92b01lbnVSZXNldCIpO2A7Cm1hc2tzLm92b01lbnVSZXNldCA9IGBAIG1hc2tzLm9uR3JpZENsaWNrID0gbnVsbDsKbWFza3Mub3ZvTWVudVJlc2V0ID0gbnVsbDsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKYDsKCmxldCBlZ2dNZW51QnV0dG9uID0ge307Cgpvcy50d2VlblRvKG92b0JvdCwgMTUsNDUsNDUsIDUpOwoKZWdnTWVudUJ1dHRvbi5vdm8gPSB0cnVlOwplZ2dNZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwplZ2dNZW51QnV0dG9uLm92b0JvdCA9ICLwn5SXIiArIG92b0JvdC5pZDsKZWdnTWVudUJ1dHRvbi50YXJnZXRWZXJzaW9uID0gb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbjsKZWdnTWVudUJ1dHRvbi5sYWJlbCA9ICJoYXRjaCAiICsgb3ZvQm90LnRhZ3MuYWJJRCArICIgdiIgKyBvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgb3ZvQm90LnRhZ3MubWF4VmVyc2lvbjsKZWdnTWVudUJ1dHRvbi5sYWJlbEFsaWdubWVudCA9ICJjZW50ZXIiOwplZ2dNZW51QnV0dG9uLm92b01lbnVSZXNldCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKZWdnTWVudUJ1dHRvbi5jb2xvciA9ICIjRkZGRkZGIjsKZWdnTWVudUJ1dHRvbi5vbkNsaWNrID0gIkAgbGlua3MubWFuYWdlci5oYXRjaE92byhsaW5rcy5vdm9Cb3QpOyI7CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihlZ2dNZW51QnV0dG9uKTsnAI6JhYgE0a8CBmNyZWF0ZQIEAI6JhYgEyIUDKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAI6JhYgE0a8CEGNoYW5nZU92b1ZlcnNpb24CBACOiYWIBO+FA/ACQC8vbG9naWMgZm9yIHZlcnNpb24gY2hhbmdpbmcgd2hlbiBtYW51YWxseSBoYXRjaGluZyBhbiBhYgpjb25zdCBvdm9Cb3QgPSBsaW5rcy5vdm9Cb3Q7CgpsZXQgbmV3VmVyc2lvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uLCB7CiAgICBwbGFjZWhvbGRlcjogImVudGVyIGEgdmVyc2lvbiBmcm9tIDEgdG8gIiArIG92b0JvdC50YWdzLm1heFZlcnNpb24KfSk7Cgpvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uID0gbmV3VmVyc2lvbjsKb3ZvQm90LnRhZ3MubGFiZWwgPSAndicrIG5ld1ZlcnNpb247Cgpjb25maWdCb3QudGFncy52ZXJzaW9uID0gbmV3VmVyc2lvbjsKCnNob3V0KCJvdm9NZW51UmVzZXQiKTsnAI6JhYgE0a8CBG1lbnUCBACOiYWIBOCIAyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCOiYWIBNGvAghhYklnbm9yZQIEAI6JhYgEh4kDBHRydWUoAI6JhYgE0a8CDGFiQm90VmVyc2lvbgF9hAMnAI6JhYgE0a8CB2FiU2hlbGwCBACOiYWIBI2JAwR0cnVlJwCOiYWIBNGvAgxhYjFMVE1TZWFyY2gCBACOiYWIBJKJAzNALy9zdXBwb3J0IG9sZCBzeW50YXgKdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsnAI6JhYgE0a8CDW9uTG9va3VwQXNrSUQCBACOiYWIBMaJA9AFQGxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLmlucHV0LmFiUHJvZ3Jlc3NCYXIoYGxvb2tpbmcgdXAgJHt0aGF0LmFza0lEfWApOwoKY29uc3QgYXNrSUQgPSAiYXNrXyIgKyB0aGF0LmFza0lEOwpjb25zdCBlbmRwb2ludCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKbGV0IGxvb2t1cEFzazsgCgp0cnkKewogICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhc2tJRCwgZW5kcG9pbnQpOwp9CmNhdGNoCnsKICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgdGhhdC5hc2tJRCwgZW5kcG9pbnQpOwp9CgppZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgbG9va3VwQXNrLmRhdGEucGF0dGVybklEKQp7CiAgICB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHthYklEOiBsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQsIHJlY29yZEtleTogbG9va3VwQXNrLmRhdGEuc3R1ZGlvSUQsIGF1dG9IYXRjaDogdHJ1ZX0pOyAgCn0KZWxzZSBpZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgIWxvb2t1cEFzay5kYXRhLnVybCkKewogICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSAhbG9va3VwQXNrLnN1Y2Nlc3M7Cn0KCmlmIChwcm9ncmVzc0J1dHRvbikKewogICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiBsb29rdXBBc2s7JwCOiYWIBNGvAgVpbnB1dAIEAI6JhYgEl48DKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAI6JhYgE0a8CBWhhdGNoAgQAjomFiAS+jwPAAUAvL3Nob3V0KCJoYXRjaCIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywga2V5OiBrZXksIGF1dG9IYXRjaDogYm9vbGVhbiwgcmV0dXJuVHlwZTogZGF0YS9udWxsLCBlZ2dQYXJhbWV0ZXJzOiBhcmd9KTsKCmNvbnN0IGxvb2tVcCA9IGF3YWl0IHRoaXNCb3Qub25Mb29rdXBBQkVnZ3ModGhhdCk7CgpyZXR1cm4gbG9va1VwOycBBGJvdHMkZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwAScAjomFiAT/kAMGc3lzdGVtAgQAjomFiASAkQMOYWIuc2hlbGwuaW5wdXQnAI6JhYgE/5ADBGZvcm0CBACOiYWIBI+RAwdub3RoaW5nJwCOiYWIBP+QAwlvbktleURvd24CBACOiYWIBJeRA21ALy9hbGxvdyBwdWxsaW5nIHVwIGNoYXQgaW4gYnVpbGRlciB2ZXJzaW9uCmlmICh0aGF0LmtleXMgPT0gImAiICYmIGJ1aWxkZXJWZXJzaW9uKQp7CiAgICBvcy5zaG93Q2hhdCgiPiIpOwp9JwCOiYWIBP+QAwZvbkNoYXQCBACOiYWIBIWSA4YZQC8vbm90IHN1cHBvcnRlZCBvdXRzaWRlIG9mIGJ1aWxkZXIgdmVyc2lvbgppZiAoIWJ1aWxkZXJWZXJzaW9uKQp7CiAgICByZXR1cm47Cn0KCi8vdGhpcyBsb29wIGlkZW50aWZpZXMgcG9zc2libGUgYWIgc3BlY2lmaWMgbWVzc2FnZXMsIGFuZCBjYWxscyBhIHNldCBsaXN0IG9mIGNvbW1hbmRzCmlmICh0aGF0Lm1lc3NhZ2VbMF0gPT0gIi4iKSAKewogICAgb3MuaGlkZUNoYXQoKTsKCiAgICBzd2l0Y2ggKHRoYXQubWVzc2FnZSkKICAgIHsKICAgICAgICBjYXNlICcuZG93bmxvYWRBQic6CiAgICAgICAgICAgIGNoYW5nZVN0YXRlKGxpbmtzLm1hbmlmZXN0YXRpb24sICJBc2xlZXAiLCAiYWJNYW5pZmVzdFN0YXRlIik7CgogICAgICAgICAgICBjb25zdCBncm91cCA9IGF3YWl0IG9zLnNob3dJbnB1dCgiZ3JvdXAiKTsKCiAgICAgICAgICAgIGlmIChncm91cCA9PSAiYWJDb25maWciKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29yZUl0ZXJhdGlvbisrOwogICAgICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5pbml0aWFsQm9vdCA9IHRydWU7CiAgICAgICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmNvcmVBQiA9IG51bGw7CiAgICAgICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoZ3JvdXAgPT0gImFiQ29yZSIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpbmtzLmxlYXJuLnRhZ3MuYWJJbnN0ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgYWJHcm91cCA9IGdldEJvdHMoZ3JvdXApOwoKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhYkdyb3VwLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhYkdyb3VwW2ldLnRhZ3MuYWJCb3RWZXJzaW9uKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIG9zLmRvd25sb2FkQm90c0FzSW5pdGlhbHphdGlvblVwZGF0ZShhYkdyb3VwLCBncm91cCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgYC5sb2FkU2tpbGxgOgogICAgICAgICAgICBsZXQgc2tpbGwgPSBhd2FpdCBvcy5zaG93SW5wdXQoInNraWxsIik7CgogICAgICAgICAgICBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBgLnN5c3RlbWA6CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVBvcnRhbCA9IHRydWU7CgogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIGAuc2hlZXRgOgogICAgICAgICAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9ICFjb25maWdCb3QudGFncy5tYXBQb3J0YWwgPyBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsIDogY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsOwoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBgLm1lbnVTaGVldGA6CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbDsKCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgYC5kb3dubG9hZGA6CiAgICAgICAgICAgIG9zLmRvd25sb2FkQm90cyhnZXRCb3RzKGJ5TW9kKHtzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpLCBvcy5nZXRDdXJyZW50SW5zdCgpKTsKCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgYC51cGxvYWRgOgogICAgICAgICAgICBvcy5zaG93VXBsb2FkQXV4RmlsZSgpOwoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBgLnNsZWVwYDoKICAgICAgICAgICAgY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCiAgICAgICAgICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKICAgICAgICAgICAgY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CiAgICAgICAgICAgIGNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgogICAgICAgICAgICB0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSBudWxsOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIGAuLmA6CiAgICAgICAgY2FzZSBgLndha2VgOgoKICAgICAgICAgICAgbGV0IHNraWxsQXJyYXkgPSBbImFiSW50ZXJmYWNlIiwgImFiQWN0aW9uIiwgImFiVGVzdHMiXTsKCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2tpbGxBcnJheS5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdChza2lsbEFycmF5W2ldKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXdhaXQgb3Muc2xlZXAoMzAwKTsKCiAgICAgICAgICAgIC8va2VlcCBhYiBhd2FrZQogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXdha2VTdGF0ZSA9IHRydWU7CgogICAgICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MucGF0dGVybikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBjb25maWdCb3QudGFncy5wYXR0ZXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSB1dWlkKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoYW5nZVN0YXRlKGxpbmtzLm1hbmlmZXN0YXRpb24sICJBd2FrZSIsICJhYk1hbmlmZXN0U3RhdGUiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJy5sb2cnOgogICAgICAgICAgICBzaG91dCgidG9nZ2xlQ29uc29sZSIpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGxldCBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwogICAgICAgICAgICBsZXQgZXhlY3V0YWJsZSA9IG1lc3NhZ2Uuc2xpY2UoMSk7CgogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3MucnVuKGV4ZWN1dGFibGUpOyAgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICB9CiAgICB9Cn0nAI6JhYgE/5ADC2Rlc2NyaXB0aW9uAgQAjomFiASMqwNCVGhpcyBpcyBtZWFudCB0byBoYW5kbGUgYW55IG5vbmUgbWVudSByZWxhdGVkIGlucHV0cy9pbnRlcmFjdGlvbnMuJwCOiYWIBP+QAwxvbkZpbGVVcGxvYWQCBACOiYWIBM+rA9cYQC8vZmlsdGVyIG91dCB0aW1lcyB3aGVuIGZpbGUgbG9hZGluZyBpcyBub3QgYWxsb3dlZAppZiAoIWJ1aWxkZXJWZXJzaW9uIHx8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJMaXN0ZW5pbmdGb3JGaWxlVXBsb2FkcyAhPT0gdHJ1ZSkKewogICAgcmV0dXJuOwp9CgovL3ZhcmlvdXMgZmlsZSBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGZpbGVFeHRlbnNpb24gPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykuc2hpZnQoKTsKbGV0IHNpemUgPSB0aGF0LmZpbGUuc2l6ZTsKbGV0IG1pbWVUeXBlOwpsZXQgYm90SW5mbyA9IHt9OwoKLy9oYXJkIGxpbWl0IGJhc2VkIG9uIGZpbGUgc2l6ZQppZiAoc2l6ZSA+IDIwMDAwMDAwMCkKewogIG9zLnRvYXN0KCJtYXhpbXVtIGZpbGUgc2l6ZSBleGNlZWRlZCAoMjAwIG1iKSIpOwoKICByZXR1cm47Cn0KCi8vdGhpcyBzd2l0Y2ggaGFuZGxlcyBwb3NzaWJsZSBmaWxlcyBleHRlbnNpb25zLCB3aGlsZSByZWplY3RpbmcgYW55IGl0IGRvZXMgbm90IHJlY29nbml6ZQpzd2l0Y2goZmlsZUV4dGVuc2lvbikKewogIGNhc2UgJ2pwZyc6CiAgY2FzZSAnanBlZyc6CiAgY2FzZSAnd2VicCc6CiAgY2FzZSAnZ2lmJzoKICBjYXNlICdwbmcnOgogICAgbWltZVR5cGUgPSAiaW1hZ2UvIiArIGZpbGVFeHRlbnNpb247CiAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgIGJyZWFrOwogIGNhc2UgJ3N2Zyc6CiAgICBtaW1lVHlwZSA9ICJpbWFnZS9zdmcreG1sIjsKICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgYnJlYWs7CiAgY2FzZSAnZ2xiJzoKICBjYXNlICdleHInOgogIGNhc2UgJ2dsdGYnOgogICAgbWltZVR5cGUgPSAidGV4dC94bWwiOwogICAgYm90SW5mby5mb3JtID0gIm1lc2giOwogICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJnbHRmIjsKICAgIGJyZWFrOwogIGNhc2UgJ2F1eCc6CiAgY2FzZSAncGRmJzoKICAgIGxldCBib3REYXRhID0gZmlsZUV4dGVuc2lvbiA9PSAiLmF1eCIgPyBKU09OLnBhcnNlKHRoYXQuZmlsZS5kYXRhKS5zdGF0ZSA6IG9zLnBhcnNlQm90c0Zyb21EYXRhKHRoYXQuZmlsZS5kYXRhKTsKCiAgICBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHtib3RzOiBib3REYXRhLCBvcmlnaW46IGZpbGVOYW1lfSk7CgogICAgcmV0dXJuOwovLyAgIGNhc2UgJ3BkZic6Ci8vICAgICBicmVhazsKICBjYXNlICdtcDMnOgogICAgbWltZVR5cGUgPSAnYXVkaW8vbXBlZyc7CiAgICBib3RJbmZvLm9uQ2xpY2sgPSAiQCBvcy5wbGF5U291bmQodGFncy5mb3JtQWRkcmVzcyk7IjsKICAgIGJvdEluZm8ubGFiZWwgPSAiQ2xpY2sgdG8gUGxheSI7CiAgICBicmVhazsKICBjYXNlICdtcDQnOgogICAgbWltZVR5cGUgPSAndmlkZW8vbXA0JzsKICAgIGJvdEluZm8uZm9ybSA9ICJpZnJhbWUiOwogICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJzcmMiOwogICAgYnJlYWs7CiAgY2FzZSAnb3RmJzoKICAgIG1pbWVUeXBlID0gJ2ZvbnQvb3RmJzsKICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICBicmVhazsKICBjYXNlICd3b2ZmJzoKICAgIG1pbWVUeXBlID0gJ2ZvbnQvd29mZic7CiAgICBib3RJbmZvLmxhYmVsID0gImV4YW1wbGUiOwogICAgYnJlYWs7CiAgZGVmYXVsdDoKICAgIGxldCByZXN1bHQgPSBuZXcgRXJyb3IoInVuaGFuZGxlZCBmaWxlIHR5cGU6ICIgKyBmaWxlRXh0ZW5zaW9uKTsKICAgIG9zLnRvYXN0KCJmaWxlIHR5cGUgbm90IHN1cHBvcnRlZCIpOwogICAgY29uc29sZS53YXJuKHJlc3VsdCkKICAgIHJldHVybiByZXN1bHQ7Cn0KCi8vdGhlIGZvbGxvd2luZyB2YXJpYWJsZXMgYW5kIG9iamVjdHMgc2V0IHVwIGEgbG9hZGluZyBiYXIgYnV0dG9uCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgpsZXQgdXBsb2FkUmVzdWx0OwpsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCB0aGlzQm90LmFiUHJvZ3Jlc3NCYXIoYHVwbG9hZGluZ2ApOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBjb25maWdCb3QudGFncy5zdHVkaW9JRCA/PyBjb25maWdCb3QudGFncy5zdHVkaW87CgppZiAoIWNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKQp7CiAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwp9CgovL3RoaXMgaXMgdGhlIGFjdHVhbCB1cGxvYWQgZnVuY3Rpb25hbGl0eQp1cGxvYWRSZXN1bHQgPSBhd2FpdCBsaW5rcy5zdG9yZS5hYlB1Ymxpc2hGaWxlKHtmaWxlOiB0aGF0LmZpbGUuZGF0YSwgZmlsZU5hbWU6IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKCi8vaWYgdGhlIGZpbGUgc2hvdWxkIGJlIGluY2x1ZGVkIGFzIGEgYm90IHdpdGggYSBsaW5rLCB0aGlzIGxvZ2ljIGhhbmRsZXMgdGhhdAoKaWYgKG1pbWVUeXBlLmluY2x1ZGVzKCJmb250IikpCnsKICAgIGJvdEluZm9bY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbF0gPSB0cnVlOwogICAgYm90SW5mby5sYWJlbEZvbnRBZGRyZXNzID0gdXBsb2FkUmVzdWx0LnVybCA/IHVwbG9hZFJlc3VsdC51cmwgOiB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKICAgIGNyZWF0ZShib3RJbmZvKTsKfQplbHNlIGlmIChPYmplY3Qua2V5cyhib3RJbmZvKS5sZW5ndGggPiAwKQp7CiAgICBib3RJbmZvW2NvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWxdID0gdHJ1ZTsKICAgIGJvdEluZm8uZm9ybUFkZHJlc3MgPSB1cGxvYWRSZXN1bHQudXJsID8gdXBsb2FkUmVzdWx0LnVybCA6IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgY3JlYXRlKGJvdEluZm8pOwp9Cgpjb25zdCBjbGlwVVJMID0gdXBsb2FkUmVzdWx0LnVybCA/PyB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKb3Muc2V0Q2xpcGJvYXJkKGNsaXBVUkwpOwoKb3MudG9hc3QoImZpbGUgdXJsIGFkZGVkIHNldCB0byBjbGlwYm9hcmQiKTsKCi8vY2xlYXIgdGhlIHByb2dyZXNzIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiB1cGxvYWRSZXN1bHQ7JwCOiYWIBP+QAwVsZWFybgIEAI6JhYgEp8QDKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAI6JhYgE/5ADCHJlbWVtYmVyAgQAjomFiATOxAMo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAjomFiAT/kAMNbWFuaWZlc3RhdGlvbgIEAI6JhYgE9cQDKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAI6JhYgE/5ADCGFiSWdub3JlAgQAjomFiAScxQMEdHJ1ZSgAjomFiAT/kAMMYWJCb3RWZXJzaW9uAX2EAycAjomFiAT/kAMGY3JlYXRlAgQAjomFiASixQMo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAjomFiAT/kAMFc3RvcmUCBACOiYWIBMnFAyjwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwCOiYWIBP+QAwRtZW51AgQAjomFiATwxQMo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAjomFiAT/kAMHYWJTaGVsbAIEAI6JhYgEl8YDBHRydWUnAI6JhYgE/5ADDWFiUHJvZ3Jlc3NCYXICBACOiYWIBJzGA98IQGlmICghY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlKQp7CiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwp9CgpsZXQgbG9hZExhYmVsID0gdGhhdCA/PyAidXBkYXRpbmciOwpsZXQgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwptZW51QnV0dG9uLmFiTWVudSA9IHRydWU7Cm1lbnVCdXR0b24ubWVudUl0ZW1TdHlsZSA9IHsgImJvcmRlci1yYWRpdXMiOiI4cHgiLCAibWFyZ2luLXRvcCI6IjNweCJ9OwptZW51QnV0dG9uLnRyYWNrTnVtID0gLTE7Cm1lbnVCdXR0b24ub25DcmVhdGUgPSBgQAogICAgaWYgKHRhZ3MudHJhY2tOdW0gPT0gMikKICAgIHsKICAgICAgICB0YWdzLnRyYWNrTnVtID0gMDsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0YWdzLnRyYWNrTnVtKys7CiAgICB9CgogICAgdGFncy5sYWJlbCA9IHRhZ3NbImxhYmVsIit0YWdzLnRyYWNrTnVtXTsKICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSB0YWdzWyJmb3JtIit0YWdzLnRyYWNrTnVtXTsKCiAgICBzZXRUaW1lb3V0KCgpID0+IHdoaXNwZXIodGhpc0JvdCwgIm9uQ3JlYXRlIiksIDUwMCk7YDsKbWVudUJ1dHRvbi5sYWJlbDAgPSBsb2FkTGFiZWwgKyAiLiI7Cm1lbnVCdXR0b24ubGFiZWwxID0gbG9hZExhYmVsICsgIi4uIjsKbWVudUJ1dHRvbi5sYWJlbDIgPSBsb2FkTGFiZWwgKyAiLi4uIjsKbWVudUJ1dHRvbi5mb3JtMCA9ICJob3VyZ2xhc3NfYm90dG9tIjsKbWVudUJ1dHRvbi5mb3JtMSA9ICJob3VyZ2xhc3NfdG9wIjsKbWVudUJ1dHRvbi5mb3JtMiA9ICJob3VyZ2xhc3NfYm90dG9tIjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubGFiZWxDb2xvciA9ICJibGFjayI7Cm1lbnVCdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKbWVudUJ1dHRvbi5hYlByb2dyZXNzUmVzZXQgPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ub25EZXN0cm95ID0gIkAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOyI7CgptZW51QnV0dG9uID0gY3JlYXRlKG1lbnVCdXR0b24pOwoKcmV0dXJuIG1lbnVCdXR0b247JwCOiYWIBP+QAwlvblRhcENvZGUCBACOiYWIBPzOA6ICQGNvbnN0IHRhcENvZGUgPSB0aGF0OwoKc3dpdGNoICh0YXBDb2RlKQp7CiAgICBjYXNlICIzMzQyIjoKICAgICAgICBvcy50b2FzdCgid2FraW5nICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5KTsKCiAgICAgICAgdGhpc0JvdC5vbkNoYXQoe21lc3NhZ2U6ICIuLiJ9KTsKICAgICAgICBicmVhazsKICAgIGNhc2UgIjQyNDIiOgogICAgICAgIG9zLnNob3dDaGF0KCI+Iik7CiAgICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICAgIC8vY29uc29sZS5sb2codGFwQ29kZSk7Cn0A"}]}